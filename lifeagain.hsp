#packopt name "Life Again"
#packopt icon "pictures/icon.ico"
#include "select_menu.as"
#include "hgimg3.as"
#include "modstr.as"
dmmini
randomize
cls 4
onexit gosub*owaru
;onerror goto*kyouseiowaru
title "Life again"
screen 0,1024,640,0,800,100//�f�o�b�N 
redraw 0 : gwx=ginfo_winx : gwy=ginfo_winy

celload "pictures/stageback/001.png" : stagebackpic(0)=stat
celload "pictures/stageback/002.png" : stagebackpic(1)=stat
celload "pictures/stageback/003.png" : stagebackpic(2)=stat
celload "pictures/stageback/004.png" : stagebackpic(3)=stat

celload "pictures/cblockset.png" : mainpic(0)=stat
celload "pictures/blockset.png" : mainpic(1)=stat
celload "pictures/player_body3.png" : mainpic(2)=stat
celload "pictures/menu_death_back.png" : mainpic(3)=stat
celload "pictures/menu_death_yes.png" : mainpic(6)=stat
celload "pictures/menu_death_no.png" : mainpic(7)=stat
celload "pictures/clear_back.png" : mainpic(4)=stat
celload "pictures/oblockset.png" : mainpic(5)=stat
celload "pictures/enemy_set.png" : mainpic(8)=stat
celload "pictures/title_logo.png" : mainpic(9)=stat
celload "pictures/ITOMA.png" : mainpic(10)=stat
celload "pictures/player_hp.png" : mainpic(11)=stat
celload "pictures/button_ue.png" : mainpic(12)=stat
celload "pictures/stage_selectUI.png" : mainpic(13)=stat
celload "pictures/small_soul_counter.png" : mainpic(14)=stat
celload "pictures/pose_menu0.png" : mainpic(15)=stat
celload "pictures/pose_menu1.png" : mainpic(16)=stat
celload "pictures/pose_menu2.png" : mainpic(17)=stat
celdiv mainpic(0),32,32 : celdiv mainpic(1),32,32
celdiv mainpic(2),64,64 : celdiv mainpic(5),32,32
celdiv mainpic(8),64,64

celload "pictures/maker/makeUI01.png" : makepic(0)=stat
celload "pictures/maker/makeUI02.png" : makepic(1)=stat
celload "pictures/maker/makeUI03.png" : makepic(2)=stat

celload "pictures/buttons/button00.png" : buttonpic(0)=stat
celload "pictures/buttons/button01.png" : buttonpic(1)=stat
celload "pictures/buttons/button02.png" : buttonpic(2)=stat
celload "pictures/buttons/button03.png" : buttonpic(3)=stat
celload "pictures/buttons/button04.png" : buttonpic(4)=stat
celload "pictures/buttons/button05.png" : buttonpic(5)=stat
celload "pictures/buttons/button06.png" : buttonpic(6)=stat

celload "pictures/��.png" : effepic(0)=stat
celload "pictures/�Q.png" : effepic(1)=stat
celload "pictures/stage_info.png" : effepic(2)=stat
celload "pictures/black_inout.png" : effepic(3)=stat
celload "pictures/big_soul0.png" : effepic(4)=stat
celload "pictures/damage_draw.png" : effepic(5)=stat
celdiv effepic(0),32,32 : celdiv effepic(1),64,64,32,32
celdiv effepic(2),320,128 : celdiv effepic(4),32,400
celdiv effepic(5),,,16,16

celload "pictures/story/player_bigbody.png" : storypic(0)=stat
celload "pictures/story/story_back00.png" : storypic(1)=stat
celload "pictures/story/telop.png" : storypic(2)=stat
celload "pictures/story/god.png" : storypic(3)=stat
celload "pictures/story/nexticon.png" : storypic(4)=stat
celload "pictures/story/house.png" : storypic(5)=stat
celload "pictures/story/player_bigbody.png" : storypic(6)=stat
celload "pictures/story/black_car.png" : storypic(7)=stat
celload "pictures/story/middleworld.png" : storypic(8)=stat
celload "pictures/story/god2.png" : storypic(9)=stat
celload "pictures/story/yes_button.png" : storypic(10)=stat
celload "pictures/story/no_button.png" : storypic(11)=stat
celdiv storypic(6),64,64

buffer 1000,gwx,gwy : tempic(0)=1000
gsel 0

dmmload "sounds/bgm_opening.wav",,1 : bgmsound(0)=stat
dmmload "sounds/bgm_select.wav",,1 : bgmsound(1)=stat
dmmload "sounds/bgm_maoudamashii_8bit20.wav",,1 : bgmsound(2)=stat
dmmload "sounds/bgm_mattarikibun.wav",,1 : bgmsound(3)=stat
dmmload "sounds/bgm_god.wav",,1 : bgmsound(4)=stat
dmmload "sounds/bgm_toikioku_healing.wav",,1 : bgmsound(5)=stat
dmmload "sounds/bgm_spring-mountain1.wav",,1 : bgmsound(6)=stat
dmmload "sounds/bgm_osare2.wav",,1 : bgmsound(7)=stat
dmmload "sounds/bgm_maoudamashii_8bit17.wav",,1 : bgmsound(8)=stat
dmmload "sounds/bgm_underground.wav",,1 : bgmsound(9)=stat
 
dmmload "sounds/maker/se_set_book.wav" : sesound(0)=stat
dmmload "sounds/maker/se_scratch.wav" : sesound(1)=stat
dmmload "sounds/se_death.wav" : sesound(2)=stat
dmmload "sounds/se_stageclear.wav" : sesound(3)=stat
dmmload "sounds/se_stageclear2.wav" : sesound(4)=stat
dmmload "sounds/se_smallsoul_get.wav" : sesound(5)=stat
dmmload "sounds/se_jump1.wav" : sesound(6)=stat
dmmload "sounds/se_jump2.wav" : sesound(7)=stat
dmmload "sounds/se_walk.wav" : sesound(8)=stat
dmmload "sounds/se_landing.wav" : sesound(9)=stat
dmmload "sounds/se_mapmove.wav" : sesound(10)=stat
dmmload "sounds/button01.wav" : sesound(11)=stat
dmmload "sounds/se_gutyo.wav" : sesound(12)=stat
dmmload "sounds/se_player_damage.wav" : sesound(13)=stat
dmmload "sounds/se_bone_crush.wav" : sesound(14)=stat
dmmload "sounds/se_enemy_rotation.wav" : sesound(15)=stat
dmmload "sounds/se_swimming.wav" : sesound(16)=stat
dmmload "sounds/se_japa-n.wav" : sesound(17)=stat
dmmload "sounds/se_door-open1.wav" : sesound(18)=stat
dmmload "sounds/se_walk-flooring1.wav" : sesound(19)=stat
dmmload "sounds/se_walk_big.wav" : sesound(20)=stat
dmmload "sounds/se_typing.wav" : sesound(21)=stat
dmmload "sounds/se_carbreke.wav" : sesound(22)=stat
dmmload "sounds/se_ga.wav" : sesound(23)=stat
dmmload "sounds/se_car_hit.wav" : sesound(24)=stat
dmmload "sounds/se_warp.wav" : sesound(25)=stat
dmmload "sounds/se_story_damage.wav" : sesound(26)=stat
dmmload "sounds/se_curebox.wav" : sesound(27)=stat
dmmload "sounds/se_boxopen.wav" : sesound(28)=stat
dmmload "sounds/se_glass_break.wav" : sesound(29)=stat

play_data_save_pace=50
play_data_load
first_dir=dir_cur
;first_story=1//�f�o�b�N
;goto*start_menu//�f�o�b�N
;goto*var_set//�f�o�b�N
;repeat : getkey a,32 : if a=1 : break
;await 16
;loop

*start_animation
	repeat 300
		redraw 1 : redraw 0
		color 0,0,0 : boxf
		if cnt<128 : color 243,0,255 : gmode 4,,,cnt*2 : pos 256,70 : celput mainpic(10),0,0.5,0.5
		if 128<=cnt : color 243,0,255 : gmode 4,,,512-cnt*2 : pos 256,70 : celput mainpic(10),0,0.5,0.5
		await 16
	loop
first_dir=dir_cur

*start_menu
	map_change=0 : fname="" : chdir first_dir
	dmmstop -1 : clrobj
	dmmplay bgmsound(8)
	smenufc 255,255,255//button�̘g
	smreset : msmenu buttonpic(4),360,340 : msmenu buttonpic(5),360,500
	repeat
		redraw 1 : redraw 0
		gosub*keycontrol
		gmode 0 : pos 0,0 : celput mainpic(9)
		color 243,0,255 : gmode 4,,,255 : ssmenu 0,0,1 : a=stat
		;logmes "a="+a
		if a=0 & (enter=1 | lclick=1): break
		if a=1 & (enter=1 | lclick=1){
			//if first_story<=1 : dialog "�ŏ��̃X�e�[�W���N���A���Ă����邱�Ƃ��ł��܂�"
			//if first_story>1 : 
			break
		}
		if F1 : break
		if esc=1 : gosub *owaru
		await 16
		if cnt<64 : gmode 3,,,255-cnt*4 : pos 0,0 : celput effepic(3)//out
	loop
	dmmstop -1 : vs_nest=0
	repeat 64 : redraw 1 : redraw 0 : black_inout cnt,0 : await 16 : loop//���o
	if F1=1 : play_mode=1 : mload_mode=-1
	if a=0{//�V��
		if first_story=0{
			wait 100
			story 0
			gosub *var_info : story 1
			story 2
			first_story=1 : a=0
		}
		play_mode=2 : mload_mode=3
	}
	if a=1 : play_mode=1 : mload_mode=0//����ėV��

*var_set
	gosub*var_map : gosub*var_enemy : gosub*var_info : goto*play_select
	
*var_map
	;memo:block_num�̃u���b�N���������瓯���u���b�N��blockmnum���������
	block_num=0,1,2,3,4,5,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34//block_picture_number//�v���C�p
	block_anip=1,1,1,1,1,3,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1//block_picture_animation_per//�A�j���[�V�����̕K�v�ȃR�}��
	block_num_vol=length(block_num)
	a=0 : repeat block_num_vol : ccnt=cnt : repeat block_anip(ccnt) : block_str(a)="b("+a+")" : a++ : loop : loop//block_str
	
	block_mnum=0,1,2,3,5,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34//block_picture_make_number//���[�J�[�p(�K�v�ȓz���������Ă���)
	repeat length(block_mnum) : block_mstr(cnt)="b("+block_mnum(cnt)+")" : loop : block_mnum_vol=length(block_mnum)
	
	cblock_num=0,47,94,141//connect_block_picture_num
	cblock_str="a(0)","a(1)","a(2)","a(3)" : cblock_num_vol=length(cblock_num)
	
	 oblock_num=0,8,32//other_block_picture_num
	oblock_anip=8,8, 8
	oblock_num_vol=length(oblock_num)
	a=0 : repeat oblock_num_vol : ccnt=cnt : repeat oblock_anip(ccnt) : oblock_str(a)="c("+a+")" : a++ : loop : loop//block_str
	
	
	;�����蔻��̂���u���b�N�i�������Ɓj
	pbhl_str="a(0)","a(1)","a(2)","b(0)","b(1)","b(2)","b(8)","b(9)","b(10)","b(11)","b(12)","b(13)","b(14)","b(17)","b(19)","b(20)","b(21)","b(22)","b(23)","b(24)","b(25)","b(26)","b(27)","b(28)","b(29)","b(30)","b(31)","b(32)","b(33)","b(34)" : pbhl_str_vol=length(pbhl_str)//player_block_hit_left_str//��
	pbhu_str="a(0)","a(1)","a(2)","b(0)","b(1)","b(2)","b(8)","b(9)","b(10)","b(11)","b(12)","b(13)","b(14)","b(18)","b(19)","b(20)","b(21)","b(22)","b(23)","b(24)","b(25)","b(26)","b(27)","b(28)","b(29)","b(30)","b(31)","b(32)","b(33)","b(34)" : pbhu_str_vol=length(pbhu_str)//��
	pbhr_str="a(0)","a(1)","a(2)","b(0)","b(1)","b(2)","b(8)","b(9)","b(10)","b(11)","b(12)","b(13)","b(14)","b(15)","b(19)","b(20)","b(21)","b(22)","b(23)","b(24)","b(25)","b(26)","b(27)","b(28)","b(29)","b(30)","b(31)","b(32)","b(33)","b(34)" : pbhr_str_vol=length(pbhr_str)//�E
	pbhd_str="a(0)","a(1)","a(2)","b(0)","b(1)","b(2)","b(8)","b(9)","b(10)","b(11)","b(12)","b(13)","b(14)","b(16)","b(19)","b(20)","b(21)","b(22)","b(23)","b(24)","b(25)","b(26)","b(27)","b(28)","b(29)","b(30)","b(31)","b(32)","b(33)","b(34)" : pbhd_str_vol=length(pbhd_str)//��
return

*var_enemy
	 enemy_num=0,6,12,18
	enemy_anip=6,6, 6, 6
	enemy_num_vol=length(enemy_num)
	a=0 : repeat enemy_num_vol : ccnt=cnt : repeat enemy_anip(ccnt) : enemy_str(a)="e("+a+")" : a++ : loop : loop//block_str

	 enemy_mnum=0,6,12,18//maker�ɕ\������G
	enemy_mnum_vol=length(enemy_num)
	eymovem=10
return

*var_info
	;mload_mode=-1//-1:�����ǂݍ��܂Ȃ�//0;new��ǂݍ���//1:play_mode=2�̂Ƃ�//2:�D���ȃX�e�[�W��I��œǂݍ���//3:temp�ǂݍ���//4:fname�������Ă���ǂݍ���//�f�o�b�N
	;play_mode=1//0:�V��//1:���//2:�X�g�[���[�ŗV��//�f�o�b�N
	black_mode=1//�u���b�N�C���A�A�E�g������
	stage_map=0//�I���X�e�[�W
	px=0 : py=0//�������W
	mx=32 : my=20 : drawmx=32 : drawmy=20//�}�b�v�T�C�Y�i�}�X�j
	bsize=32//�u���b�N�̃T�C�Y
	mapvmv=1//map_void_mass_vol
	cblock_vol=47//connect_block_vol
	pxmovem=4 : pymovem=15//player_movex_max//�v���C���[�̍ő呬�x(�s�N�Z����)
	pxmovep=2 : pymovep=1//�����A�����̂��₷��
	pymovem_plus=5//�������̏d�̓p�l���ɏd�Ȃ����Ƃ���pymove�̍ő�l��ω�������
	player_hp=20 : player_hpm=20
	ptrans=255.0//�v���C���[�̔���
	wx_move_flame=50 : wy_move_flame=50//wx_move��rwx_move�̒l�ɂȂ�̂ɉ��t���[�����邩
	panicp=8//player_animation_check_per//��̃A�j���[�V������ς���܂ł̃t���[����
	panipc=4,4,2,4,2,4,1,1,4,4//player_ani_per_count//�e�A�j���[�V�����Ɏg���R�}�̖���(�I�_���������菑���܂��傤�A�z�񂪑���Ȃ��Ȃ�܂�)
	a=0 : repeat length(panipc) : panip(cnt)=a : a=a+panipc(cnt) : loop//player_ani_per(�I�_���������菑���܂��傤�A�z�񂪑���Ȃ��Ȃ�܂�)
	panipf=8,8,8,4,8,4,1,1,0//pani_per_flame//�؂�ւ��ɂ�����t���[����
	sb_mode=0 : sblock="a(0)"//set_block_mode//0:�u���b�N//1:���̑�//2:�G
	play_data_save_pace=50//�Z�[�u����t�@�C���̊Ԋu
	pbh_cless=3//pbh�̃`�F�b�N�񐔂����炷
	kodama_vol=0

	mxmax=200 : mymax=100//x,y�̍ő�}�X��
	sdim map,0,mxmax+mapvmv*2,mymax+mapvmv*2//�u���b�N�f�[�^��ۑ�����ϐ�
	dim animap,mxmax+mapvmv*2,mymax+mapvmv*2//�u���b�N�̃A�j���[�V�������
	dim animapc,mxmax+mapvmv*2,mymax+mapvmv*2//�u���b�N�̃A�j���[�V�������
	sdim omap,0,mxmax+mapvmv*2,mymax+mapvmv*2//���̑��u���b�N
	sdim emap,0,mxmax+mapvmv*2,mymax+mapvmv*2//�G
	dim edmap,mxmax+mapvmv*2,mymax+mapvmv*2//�G�̕���
	dim ecmxmap,mxmax+mapvmv*2,mymax+mapvmv*2//�G�̍s���\�͈�(x)
	dim ecmymap,mxmax+mapvmv*2,mymax+mapvmv*2//�G�̍s���\�͈�(y)
	repeat mymax+mapvmv*2 : ycnt=cnt : repeat mxmax+mapvmv*2 : xcnt=cnt : map(xcnt,ycnt)="0" : animap(xcnt,ycnt)=0 : animapc(xcnt,ycnt)=0 : omap(xcnt,ycnt)="0" : emap(xcnt,ycnt)="0" : edmap(xcnt,ycnt)=0 : ecmxmap(xcnt,ycnt)=0 : ecmymap(xcnt,ycnt)=0  : loop : loop//�}�b�v��������

	;if mload_mode=0 : gosub*map_load
	if play_mode=1 : mload_mode=4 : fname="map/new" : ffname=fname : gosub *map_load : msave_mode=0//debug
return

*play_select
	clrobj//�I�u�W�F�N�g����
	gosub *map_bgm
	if play_mode=0{
		goto*main
	}
	if play_mode=1{
		goto*mmain
	}
	if play_mode=2{
		goto*stage_select_main
	}
	title "�������B�X�g�b�v������(*play_select�̌�)" : stop

*main//make
	back_to_select=0
	player_hp=player_hpm//�̗̓��Z�b�g
	vs_nest=0 : pgoal=0 : pdeath=0 : pymove=0 : pg=0 : pxmove=0
	rwx_move=gwx/2-px : rwy_move=gwy/2-py//�J�����̏������W
	damage_effect_vol=0 : player_damage_mode=0 : pdcnt=0
	repeat
		//title ""+cnt
		redraw 1 : redraw 0
		acnt=cnt
		gosub*var_update
		gosub*keycontrol
		gosub*map_draw
		gosub*enemy_draw
		gosub*pdeath_check
		gosub*player_mode
		gosub*player_draw
		gosub*player_UI
		if esc=1 : gosub*pose_menu
		if black_mode=1 &  cnt<64 : black_inout cnt,1
		/*�v���C���[�̕`��́u�P�F�`��@�Q�F���W�ړ��v�̂��ߕ`�掩�̂͑O��̍��W�ɂȂ��Ă���B�Ȃ̂ŁA����ȍ~��
		�v���C���[���W�֌W�̏������s���ƁA�P�t���[���O�̏����ɂȂ��Ă��܂����߂�߂��ق�������*/
		if vs_nest=1 : break
		await 16
	loop
	if back_to_select=1{
		if map_change=1 : dialog "�}�b�v��ۑ����܂����H",2 : a=stat : if a=6 : msave_mode=0 : gosub*map_save
		black_inout 0,2 : goto*start_menu
	}
	if back_to_select=2 : black_inout 0,2 : wait 10 : goto*stage_select_main
	if pgoal=1 : goto*stage_clear//�S�[�����̉��o
	if pdeath=1 : goto*menu_death//���S���̉��o
	if F1=1 & play_mode=0 : px=fpx : py=fpy : mload_mode=3 : gosub*map_load : black_mode=0 : goto*main//�����X�e�[�W���ēx�ǂݍ���//�Ⴄ�X�e�[�W��ǂݍ���
	if F3=1 & play_mode=0 : play_mode=1 : mload_mode=3 : gosub*map_load : wx_move=gwx/2-px : wy_move=gwy/2-py : goto*play_select//��郂�[�h�ɐ؂�ւ�
	
*mmain//make_main
	vs_nest=0 : menu=0 : pg=0 : back_to_select=0
	smreset//�{�^��������
	smenufc 0,0,0//button�̘g
	msmenu buttonpic(1),890,480 : msmenu buttonpic(0),890,530 : msmenu buttonpic(6),890,580 : msmenu buttonpic(2),730,555 : msmenu buttonpic(3),730,590
	clrobj
	pos 0,0 : input iranaiinput,0,0 : pos 730,497 : input mx,40,20,3 : pos 730,535 : input my,40,20,3//�}�b�v�̃T�C�Y�ύX�悤
	pos 800,480 : chkbox "�h��Ԃ�",fill_mode
	repeat
		redraw 1 : redraw 0
		acnt=cnt
		gosub*var_update
		gosub*keycontrol
		gosub*map_draw
		gosub*player_mode
		gosub*mplayer_draw//make_player_draw
		gosub*makeUI
		gosub*anything_set
		if esc=1 : gosub*pose_menu
		await 16
		if black_mode=1 & cnt<64 : black_inout cnt,1
		if vs_nest=1 : break
	loop
	;key
	if F3=1 & play_mode=1{
		check=msave_mode : msave_mode=2 : gosub*map_save : msave_mode=check
		if goalcheck=0 : play_mode=1 : goto*play_select
		if goalcheck=1 : play_mode=0 : mload_mode=3 : gosub*map_load : goto*play_select//��������}�b�v��temp�ɕۑ����ėV�ԃ��[�h�ɂ���
	}
	;button
	if back_to_select=1{
		if map_change=1 : dialog "�}�b�v��ۑ����܂����H",2 : a=stat : if a=6 : msave_mode=0 : gosub*map_save
		black_inout 0,2 : goto*start_menu
	}
	if menu=1 | F1=1{//�ǂݍ���
		mload_mode=2 : gosub*map_load : msave_mode=1 :  wx_move=gwx/2-px : wy_move=gwy/2-py
		if black_mode=1 : repeat 64 : redraw 1 : redraw 0 : black_inout cnt,0 : await 16 : loop
		goto*mmain
	}
	if menu=2 | (menu=3 & msave_mode=0){
		check=msave_mode//�����ۑ��ł��Ȃ�������A���ɖ߂�
		msave_mode=0 : gosub*map_save : msave_mode=1 : black_mode=0 : goto*mmain//���O��t���ĕۑ�
	}
	if menu=3 : msave_mode=1 : gosub*map_save : black_mode=0 : goto*mmain//�㏑���ۑ�
	if menu=4{//�܂�����ɂ���
		gosub*clean_map
		mx=32 : my=20 : px=bsize*5 : py=msy-bsize*4 : fpx=0 : fpy=0 : wx_move=200 : wy_move=gwy/2-py : black_mode=0
		goto*mmain
	}
*stage_select_main
	pdeath=0 : pgoal=0 : pg=0 : pymove=0 : pxmove=0 : back_to_select=0 : player_hp=player_hpm
	gosub *stage_select_load//�X�e�[�W�̃}�b�v�����[�h
	if map_move=1 : px=smpx : py=smpy : wx_move=gwx/2-px : wy_move=gwy/2-py : rwx_move=gwx/2-px : rwy_move=gwy/2-py
	rsgate//�Q�[�g�����Z�b�g
	dmmstop -1
	if stage=0{//�Q�[�g��z�u
		dmmplay bgm_sound(0)//bgm
		mkgate "�`���[�g���A��",580,320
		mkgate "www���߂̑���www",1088,380
		mkgate "�[�����A��",1248,940
		mkgate "�X���n���������R",2272,352
	}stage_map_name=""
	vs_nest=0 : map_move=0
	repeat
		redraw 1 : redraw 0
		acnt=cnt
		gosub*var_update
		gosub*keycontrol
		gosub*map_draw : drgate
		gosub*pdeath_check
		gosub*player_mode
		gosub*player_draw
		color 243,0,255 : gmode 4,,,255 : pos 0,0 : celput mainpic(13) : font "",32 : color 0,0,0 : pos 292,0 : mes akodama_vol
		if esc=1 : logmes "�ʂ���" : gosub*pose_menu
		if cnt<64 : black_inout cnt,1
		await 16
		if vs_nest=1 : break
	loop
	logmes "�ʂ���2" : 
	if back_to_select=1 : black_inout 0,2 : wait 10 : goto*start_menu
	if ue=1 & map_move=1 : mload_mode=1 : smpx=px : smpy=py : goto*map_move_animation//select_main_px
*stage_select_load
	mload_mode=4 : gosub*clean_map : fname="map/stage_select/"+stage : gosub*map_load//�X�e�[�W�I��p�̃}�b�v��ǂݍ���
return

*map_move_animation
	b=200 : mmani=1//map_move_animation
	ga=0//�������E�B���h
	bai=1.5
	repeat b
		redraw 1 : redraw 0
		gosub*keycontrol
		gosub*map_draw
		drgate
		
		color 243,0,255 : gmode 4,,,255 : //�v���C���[��`��
		if pg=0 | pg=4 :  pos px+wx_move,py+wy_move : celput mainpic(2),pani
		if pg=2 : pos px+wx_move+psizex,py+wy_move : celput mainpic(2),pani,,,deg2rad(180)

		gsel tempic(0)
		gmode 0 : pos 0,0 : celput ga
		gsel ga// : celdiv tempic(0),,,px+wx_move+psizex,py+wy_move+psizey/2
		color 0,0,0 : boxf
		//pos 0,0 : gzoom gwx,gwy,tempic(0),(px+wx_move+psizex-cnt),(py+wy_move+psizey/2-cnt),3.2*cnt,2.0*cnt
		pos 0,0 : gzoom gwx,gwy,tempic(0),cnt*bai+psizex,cnt*bai,gwx-3.2*cnt*bai,gwy-2.0*cnt*bai
		//logmes "x="+(px+wx_move+psizex-cnt)+" y="+(py+wy_move+psizey/2-cnt)+"x="+(3.2*cnt)+" y="+(2.0*cnt)
		//pos px+wx_move+psizex,py+wy_move+psizey/2 : celput tempic(0),,0.5*cnt+1,0.4*cnt+1
		//celdiv tempic(0),,0,0
		if cnt>b-64 : black_inout cnt,0
		await 16
	loop
	mmani=0
	gosub*clean_map : mload_mode=1 : gosub*map_load : gosub *map_bgm : goto*main

*var_update
	msx=bsize*mx : msy=bsize*my
	if mx<0 | mxmax<mx : mx=limit(mx,0,mxmax) : objprm 0,mx
	if my<0 | mymax<my : my=limit(my,0,mymax) : objprm 0,my
	//mx=limit(mx,0,mxmax) : my=limit(my,0,mymax)
	//objprm 0,mx : objprm 1,my
return
*keycontrol
	getkey lclick,1 : getkey rclick,2 : getkey mclick,4
	getkey enter,13 : getkey shift,16 : getkey ctrl,17 : getkey space,32
	getkey hidari,37 : getkey ue,38 : getkey migi,39 : getkey sita,40
	
	getkey esc,27 : getkey F1,112 : getkey F2,113 : getkey F3,114
	if F1=1 & play_mode=0 : vs_nest=1
	;if F2=1 & play_mode=1 : vs_nest=1
	if F3=1 & F3p=0 & (play_mode=0 | play_mode=1) : F3p=1 : vs_nest=1 : else : if F3=0 : F3p=0

	moux=mousex : mouy=mousey : mouw=mousew//�}�E�X�̒l
	;if lclick=1 : logmes "mousex="+(mousex-wx_move)+" mousey="+(mousey-wy_move)
return

*map_bgm
	dmmstop -1
	if play_mode=0 : dmmplay bgmsound(0)
	if play_mode=1 : dmmplay bgmsound(7)
	if play_mode=2{
		a=stage_map_name
		;logmes "�X�e�[�W����"+a
		if stage=0{
			if a="" | a="www���߂̑���www" | a="�X���n���������R" : dmmplay bgmsound(0)
			if a="�`���[�g���A��" : dmmplay bgmsound(5)
			if a="�[�����A��" : dmmplay bgmsound(9)
		}
	}
return
*map_back
	pos wx_move/10,wy_move/10
	if play_mode=0 | play_mode=1 : celput stagebackpic(0)//�t�݂�����
	if play_mode=2{
		a=stage_map_name
		;logmes "�X�e�[�W����"+a
		if stage=0{
			if a="" | a="www���߂̑���www" : celput stagebackpic(0)
			if a="�`���[�g���A��" : celput stagebackpic(1)//���ᎆ
			if a="�[�����A��" : celput stagebackpic(2)//���A
			if a="�X���n���������R" : celput stagebackpic(3)//��
		}
	}
	
return
*map_draw//�}�b�v��`��
	;wx,wy_move����(�v���C���[�ړ���)
	
	if play_mode=0 | play_mode=2{//�V��ł�����
		rwx_move=gwx/2-px : rwy_move=gwy/2-py//���ۂ̃J�����ʒu
		wx_movec=(rwx_move-wx_move)/wx_move_flame : wy_movec=(rwy_move-wy_move)/wy_move_flame*2//�ړ����镝
		wx_move=limit(wx_move+wx_movec,-abs(gwx-msx),0) : wy_move=limit(wy_move+wy_movec,-abs(gwy-msy),0)//�J�����̈ʒu����
		;logmes "wx_move="+wx_move+" wy_move="+wy_move+" rwx_move="+rwx_move+" rwy_move="+rwy_move
	}
		
	;back//�w�i
	if mclick=1 & (play_mode=0 | play_mode=1){//�z�C�[���N���b�N�ŉ�ʂ��ړ�
		if mclickp=0 : bmoux=moux : bmouy=mouy : bwx_move=wx_move : bwy_move=wy_move : mclickp=1//�}�E�X�z�C�[�����������獡��moux,mouy,wx_move,wy_move�̒l���ꎞ�ۑ�
		if mclickp=1 : wx_move=bwx_move-(bmoux-moux) : wy_move=bwy_move-(bmouy-mouy)
		if play_mode=0 : wx_move=limit(wx_move+wx_movec,-abs(gwx-msx),0) : wy_move=limit(wy_move+wy_movec,-abs(gwy-msy),0)
	}if mclick=0 & mclickp=1 : mclickp=0
	if mmani=0 : gmode 0 : color 0,0,0 : boxf
	gosub*map_back
	
	//color 250,250,250 : boxf//���H�p
	
	;��
	if play_mode=1{
		color 0,0,0
		repeat mx : line bsize*cnt+wx_move,0,bsize*cnt+wx_move,gwy : loop
		repeat my : line 0,bsize*cnt+wy_move,gwx,bsize*cnt+wy_move : loop
		color 255,0,0 : boxline wx_move,wy_move,wx_move+msx,wy_move+msy//line wx_move,0,wx_move,gwy : line wx_move+msx,0,wx_move+msx,gwy
	}
	;block//�u���b�N
	repeat drawmy+2//my
		ycnt=cnt+mapvmv-wy_move/bsize
		repeat drawmx+2//mx
			xcnt=cnt+mapvmv-wx_move/bsize : check=0
			//logmes "xcnt="+xcnt+" ycnt="+ycnt
			//if -bsize<bsize*(xcnt-mapvmv)+wx_move & bsize*(xcnt-mapvmv)+wx_move<gwx & -bsize<bsize*(ycnt-mapvmv)+wy_move & bsize*(ycnt-mapvmv)+wy_move<gwy{
			if 0<xcnt & xcnt<=mx & 0<ycnt & ycnt<=my{
				;���̑��u���b�N
				check=0
				c=omap(xcnt,ycnt)//�m�F�p
				d=strmid(c,0,1)//�ꎞ�I
				gmode 3,,,150
				if d="c"{//���̑��̃u���b�N�z�u
					pos bsize*(xcnt-mapvmv)+wx_move,bsize*(ycnt-mapvmv)+wy_move//�\��ʒu
					repeat//�J�b�R�̒��̐���������
						ccnt=cnt
						a=strmid(c,2+ccnt,1)//a:�ꎞ�I
						if a=")" : break
					loop
					b=int(strmid(c,2,ccnt))//b:�ꎞ�I��()�̒��̐�������
					hosii=oblock_num(b)

					min=0 : max=oblock_num_vol-1 : ans=(max-min)/2
					repeat;�񕪒T���@��b�ƊY������block_num�̔ԍ������߂�
						if oblock_num(ans)>hosii : max=ans : ans=ans-(max-min)/2
						if oblock_num(ans)<hosii : min=ans : ans=ans+(max-min)/2
						if min=hosii & max=1 : ans=0
						if min=oblock_num_vol-2 : max=oblock_num_vol-1 : ans=oblock_num_vol-1
						//logmes "�ق����l��"+hosii+" oblock_num(ans)="+oblock_num(ans)+" ans="+ans+" min="+min+" max="+max
						if oblock_num(ans)=hosii : break
						//await 1
					loop
					//logmes "break!!"
					if oblock_anip(ans)=1 : celput mainpic(5), oblock_num(ans) : check=1
					if oblock_anip(ans)!1 : celput mainpic(5), oblock_num(ans)+animap(xcnt,ycnt) : check=1
					;�A�j���[�V�������X�V
					if play_mode=0 | play_mode=2{
						if c="c(0)" | c="c(1)" : animapc(xcnt,ycnt)++ : if animapc(xcnt,ycnt)\10=0 : animap(xcnt,ycnt)++ : animap(xcnt,ycnt)=animap(xcnt,ycnt)\oblock_anip(ans) : animapc(xcnt,ycnt)=0
						if c="c(2)" : animapc(xcnt,ycnt)++ : if animapc(xcnt,ycnt)\5=0 : animap(xcnt,ycnt)++ : animap(xcnt,ycnt)=animap(xcnt,ycnt)\oblock_anip(ans) : animapc(xcnt,ycnt)=0
					}
				}
				;�ʏ�u���b�N
				check=0
				pos bsize*(xcnt-mapvmv)+wx_move,bsize*(ycnt-mapvmv)+wy_move//�\��ʒu
				c=map(xcnt,ycnt)//�m�F�p
				d=strmid(c,0,1)//�ꎞ�I
				color 243,0,255 : gmode 4,,,255
				
				if d="a"{//connect�u���b�N��z�u
					repeat//�J�b�R�̒��̐���������
						ccnt=cnt
						a=strmid(c,2+ccnt,1)//a:�ꎞ�I
						if a=")" : break
					loop
					b=strmid(c,2,ccnt)//b:�ꎞ�I��()�̒��̐�������
					color 243,0,255 : gmode 4,,,255
					
					if map(xcnt-1,ycnt)=c & map(xcnt,ycnt-1)=c & map(xcnt+1,ycnt)=c & map(xcnt,ycnt+1)=c & check=0{;�S��//�S��͂���Ă�
						if map(xcnt-1,ycnt+1)!c & map(xcnt-1,ycnt-1)!c & map(xcnt+1,ycnt-1)!c & map(xcnt+1,ycnt+1)!c & check=0 : celput mainpic(0),30+cblock_vol*b : check=1;4�ӏ���
						if map(xcnt-1,ycnt+1)!c & map(xcnt-1,ycnt-1)!c & map(xcnt+1,ycnt-1)!c & check=0 : celput mainpic(0),26+cblock_vol*b : check=1;3�ӏ���//�����ƍ���ƉE��
						if map(xcnt-1,ycnt-1)!c & map(xcnt+1,ycnt-1)!c & map(xcnt+1,ycnt+1)!c & check=0 : celput mainpic(0),27+cblock_vol*b : check=1//����ƉE��ƉE��
						if map(xcnt+1,ycnt-1)!c & map(xcnt+1,ycnt+1)!c & map(xcnt-1,ycnt+1)!c & check=0 : celput mainpic(0),28+cblock_vol*b : check=1//�E��ƉE���ƍ���
						if map(xcnt+1,ycnt+1)!c & map(xcnt-1,ycnt+1)!c & map(xcnt-1,ycnt-1)!c & check=0 : celput mainpic(0),29+cblock_vol*b : check=1//�E���ƍ����ƍ���
						if map(xcnt-1,ycnt+1)!c & map(xcnt-1,ycnt-1)!c & check=0 : celput mainpic(0),20+cblock_vol*b : check=1;2�ӏ���//�����ƍ���
						if map(xcnt-1,ycnt-1)!c & map(xcnt+1,ycnt-1)!c & check=0 : celput mainpic(0),21+cblock_vol*b : check=1//����ƉE��
						if map(xcnt+1,ycnt-1)!c & map(xcnt+1,ycnt+1)!c & check=0 : celput mainpic(0),22+cblock_vol*b : check=1//�E��ƉE��
						if map(xcnt+1,ycnt+1)!c & map(xcnt-1,ycnt+1)!c & check=0 : celput mainpic(0),23+cblock_vol*b : check=1//�E���ƍ���
						if map(xcnt-1,ycnt-1)!c & map(xcnt+1,ycnt+1)!c & check=0 : celput mainpic(0),24+cblock_vol*b : check=1//����ƉE��
						if map(xcnt-1,ycnt+1)!c & map(xcnt+1,ycnt-1)!c & check=0 : celput mainpic(0),25+cblock_vol*b : check=1//�����ƉE��
						if map(xcnt-1,ycnt-1)!c & check=0 : celput mainpic(0),16+cblock_vol*b : check=1//����
						if map(xcnt+1,ycnt-1)!c & check=0 : celput mainpic(0),17+cblock_vol*b : check=1//�E��
						if map(xcnt+1,ycnt+1)!c & check=0 : celput mainpic(0),18+cblock_vol*b : check=1//�E��
						if map(xcnt-1,ycnt+1)!c & check=0 : celput mainpic(0),19+cblock_vol*b : check=1//����
						if check=0 : celput mainpic(0),15+cblock_vol*b : check=1//�[�����܂��Ă�
					}
					if map(xcnt,ycnt-1)=c & map(xcnt+1,ycnt)=c & map(xcnt,ycnt+1)=c & check=0{;�R�͂܂�Ă�`//������
						if map(xcnt+1,ycnt-1)!c & map(xcnt+1,ycnt+1)!c & check=0 : celput mainpic(0),39+cblock_vol*b : check=1//�E��ƉE��
						if map(xcnt+1,ycnt-1)!c & check=0 : celput mainpic(0),38+cblock_vol*b : check=1//�E��
						if map(xcnt+1,ycnt+1)!c & check=0 : celput mainpic(0),37+cblock_vol*b : check=1//�E��
						if check=0 : celput mainpic(0),11+cblock_vol*b : check=1
					}if map(xcnt-1,ycnt)=c & map(xcnt+1,ycnt)=c & map(xcnt,ycnt+1)=c & check=0{//�����
						if map(xcnt+1,ycnt+1)!c & map(xcnt-1,ycnt+1)!c & check=0 : celput mainpic(0),42+cblock_vol*b : check=1//�E���ƍ���
						if map(xcnt+1,ycnt+1)!c & check=0 : celput mainpic(0),41+cblock_vol*b : check=1//�E��
						if map(xcnt-1,ycnt+1)!c & check=0 : celput mainpic(0),40+cblock_vol*b : check=1//����
						if check=0 : celput mainpic(0),12+cblock_vol*b : check=1
					}if map(xcnt-1,ycnt)=c & map(xcnt,ycnt-1)=c & map(xcnt,ycnt+1)=c & check=0{//�E����
						if map(xcnt-1,ycnt+1)!c & map(xcnt-1,ycnt-1)!c & check=0 : celput mainpic(0),33+cblock_vol*b : check=1;2�ӏ���//�����ƍ���
						if map(xcnt-1,ycnt-1)!c & check=0 : celput mainpic(0),31+cblock_vol*b : check=1//����
						if map(xcnt-1,ycnt+1)!c & check=0 : celput mainpic(0),32+cblock_vol*b : check=1//����
						if check=0 : celput mainpic(0),13+cblock_vol*b : check=1
					}if map(xcnt-1,ycnt)=c & map(xcnt,ycnt-1)=c & map(xcnt+1,ycnt)=c & check=0{//������
						if map(xcnt-1,ycnt-1)!c & map(xcnt+1,ycnt-1)!c & check=0 : celput mainpic(0),36+cblock_vol*b : check=1//����ƉE��
						if map(xcnt-1,ycnt-1)!c & check=0 : celput mainpic(0),35+cblock_vol*b : check=1//����
						if map(xcnt+1,ycnt-1)!c & check=0 : celput mainpic(0),34+cblock_vol*b : check=1//�E��
						if check=0 : celput mainpic(0),14+cblock_vol*b : check=1
					}
					if map(xcnt-1,ycnt)=c & map(xcnt+1,ycnt)=c & check=0 : celput mainpic(0),9+cblock_vol*b : check=1;�Q�͂܂�Ă�`//���ɂQ����
					if map(xcnt,ycnt-1)=c & map(xcnt,ycnt+1)=c & check=0 : celput mainpic(0),10+cblock_vol*b : check=1//�c�ɂQ����
					if map(xcnt+1,ycnt)=c & map(xcnt,ycnt+1)=c & check=0{//�E�Ɖ��ɂ���
						if map(xcnt+1,ycnt+1)!c & check=0 : celput mainpic(0),45+cblock_vol*b : check=1
						if check=0 : celput mainpic(0),5+cblock_vol*b : check=1
					}if map(xcnt-1,ycnt)=c & map(xcnt,ycnt+1)=c & check=0{//���Ɖ��ɂ���
						if map(xcnt-1,ycnt+1)!c & check=0 : celput mainpic(0),46+cblock_vol*b : check=1
						if check=0 : celput mainpic(0),6+cblock_vol*b : check=1
					}if map(xcnt-1,ycnt)=c & map(xcnt,ycnt-1)=c & check=0{//���Ə�ɂ���
						if map(xcnt-1,ycnt-1)!c & check=0 : celput mainpic(0),43+cblock_vol*b : check=1
						if check=0 : celput mainpic(0),7+cblock_vol*b : check=1
					}if map(xcnt+1,ycnt)=c & map(xcnt,ycnt-1)=c & check=0{//�E�Ə�ɂ���
						if map(xcnt+1,ycnt-1)!c & check=0 : celput mainpic(0),44+cblock_vol*b : check=1
						if check=0 : celput mainpic(0),8+cblock_vol*b : check=1
					}
					if map(xcnt+1,ycnt)=c & check=0 : celput mainpic(0),1+cblock_vol*b : check=1;�P�͂܂�Ă�//�E�ɂ���
					if map(xcnt-1,ycnt)=c & check=0 : celput mainpic(0),2+cblock_vol*b : check=1//���ɂ���
					if map(xcnt,ycnt+1)=c & check=0 : celput mainpic(0),3+cblock_vol*b : check=1//���ɂ���
					if map(xcnt,ycnt-1)=c & check=0 : celput mainpic(0),4+cblock_vol*b : check=1//��ɂ���
					if check=0 :  celput mainpic(0),0+cblock_vol*b : check=1
				}
				if d="b" & check=0{//���ʂ̃u���b�N�z�u
					repeat//�J�b�R�̒��̐���������
						ccnt=cnt
						a=strmid(c,2+ccnt,1)//a:�ꎞ�I
						if a=")" : break
					loop
					b=int(strmid(c,2,ccnt))//b:�ꎞ�I��()�̒��̐�������

					min=0 : max=block_num_vol-1 : ans=(max-min)/2
					repeat;�񕪒T���@��b�ƊY������block_num�̔ԍ������߂�
						if block_num(ans)>b : max=ans : ans=ans-(max-min)/2
						if block_num(ans)<b : min=ans : ans=ans+(max-min)/2
						if min=0 & max=1 : ans=0
						if min=block_num_vol-2 : max=block_num_vol-1 : ans=block_num_vol-1
						//logmes "�ق����l��"+b+" block_num(ans)="+block_num(ans)+" ans="+ans+" min="+min+" max="+max
						if block_num(ans)=b : break
						//await 1
					loop
					//logmes "break!!"
					
					if block_anip(ans)=1 : celput mainpic(1),b : check=1
					if block_anip(ans)!1 : celput mainpic(1),b+animap(xcnt,ycnt) : check=1
					;�A�j���[�V�������X�V
					if (play_mode=0 | play_mode=2){
						if c="b(5)" : animapc(xcnt,ycnt)++ : if animapc(xcnt,ycnt)\20=0 : animap(xcnt,ycnt)++ : animap(xcnt,ycnt)=animap(xcnt,ycnt)\block_anip(ans) : animapc(xcnt,ycnt)=0//����
					}
				}
				;�G
				if play_mode=1{//��郂�[�h�̎�
					c=emap(xcnt,ycnt)//�m�F�p
					d=strmid(c,0,1)//�ꎞ�I
					if d="e"{//�G��z�u
						pos bsize*(xcnt-mapvmv)-bsize/2+wx_move,bsize*(ycnt-mapvmv)-bsize+wy_move//�\��ʒu
						repeat//�J�b�R�̒��̐���������
							ccnt=cnt
							a=strmid(c,ccnt,1)//a:�ꎞ�I
							if a=")" : break
						loop
						b=int(strmid(c,2,ccnt))//b:�ꎞ�I��()�̒��̐�������
						hosii=enemy_num(b)
	
						min=0 : max=enemy_num_vol-1 : ans=(max-min)/2
						repeat;�񕪒T���@��b�ƊY������block_num�̔ԍ������߂�
							if enemy_num(ans)>hosii : max=ans : ans=ans-(max-min)/2
							if enemy_num(ans)<hosii : min=ans : ans=ans+(max-min)/2
							if min=hosii & max=1 : ans=0
							if min=enemy_num_vol-2 : max=enemy_num_vol-1 : ans=enemy_num_vol-1
							;logmes "�ق����l��"+hosii+" oblock_num(ans)="+oblock_num(ans)+" ans="+ans+" min="+min+" max="+max
							if enemy_num(ans)=hosii : break
							;await 1
						loop
						//logmes "break!!"
						;logmes "c="+c
						if ans=0 | ans=1 | ans=2 | ans=3{
							;logmes "�ʂ���"
							celput mainpic(8),enemy_num(ans)+(enemy_anip(ans)/2)*(edmap(xcnt,ycnt)\2) : check=1//�`��
						}
					}
				}
			//if pgoal=1 : logmes "xcnt="+xcnt+" ycnt="+ycnt
			}
		loop
	loop
return

*enemy_draw
	;logmes "enemy_vol="+enemy_vol
	canjump=0
	repeat enemy_vol
		ecnt=cnt
		a=enemysnum(ecnt)//�G�̔ԍ�
		if -wx_move-bsize*5<=enemypx(ecnt) & enemypx(ecnt)<-wx_move+gwx+bsize*5 & -wy_move-bsize*5<=enemypy(ecnt) & enemypy(ecnt)<-wy_move+gwy+bsize*5 & enemyl(ecnt)!0{
			
*enemy_bedodo
			if a=0{//�����x�h�h�Ȃ�`
				enemy_info 25,35,38,63
				epos bsize/2,bsize : color 243,0,255
				if enemyl(ecnt)=0{//����ł���
					if edcnt(ecnt)<8{//��莞�ԕ`��
						edcnt(ecnt)++
						if enemydir(ecnt)=0{//������������������`
							celput mainpic(8),enemy_num(a)+(enemy_anip(a)/2)-1
						}
						if enemydir(ecnt)=1{//�����E������������`
							celput mainpic(8),enemy_num(a)+enemy_anip(a)-1
						}
					}
				}
				if enemyl(ecnt)>0{//�����Ă���
					if enemydir(ecnt)=0 & edcheck(ecnt)=0{//������������������`
						celput mainpic(8),enemy_num(a)+((enemy_anipc(ecnt)/20)\((enemy_anip(a)/2)-1))
						;��
						enemypx(ecnt)-0.5 : ebh 0,0,0,255,0 : d=stat; : logmes "d="+d
						//if d=0 : �u���b�N���Ȃ�������ړ�������
						if d!0 : enemydir(ecnt)=1 : enemy(ecnt)+0.5 : edcheck(ecnt)=1
					}
					if enemydir(ecnt)=1 & edcheck(ecnt)=0{//�����E������������`
						celput mainpic(8),enemy_num(a)+((enemy_anipc(ecnt)/20)\((enemy_anip(a)/2)-1))+enemy_anip(a)/2
						;�E
						enemypx(ecnt)+0.5 : ebh 2,0,0,255,0 : d=stat; : logmes "d="+d
						//if d=0 : �u���b�N���Ȃ�������ړ�������
						if d!0 : enemydir(ecnt)=0 : enemy(ecnt)-0.5 : edcheck(ecnt)=1
					}
					ebh 3 : d=stat
					if d=0 : eymove(ecnt)+1//�n�ʂ��Ȃ�������
					;�㉺�ړ�
					repeat abs(eymove(ecnt))
						if eymove(ecnt)<0{//�㏸����������
							ebh 1,0,255,100,255 : d=stat
							if d=0 : enemypy(ecnt)-1
							if d!0 : eymove(ecnt)=0 : break
						}if eymove(ecnt)>0{//���~����������
							ebh 3,0,0,255,255 : d=stat
							if d=0 : enemypy(ecnt)+1
							if d!0 : eymove(ecnt)=0 : break
						}
					loop
					ehitcheck 3,0,1
					enemy_anipc(ecnt)++
					if enemyl(cnt)=0 : dmmplay sesound(12)//���S��
				}
				
			}
*enemy_gaikotu
			if a=1 | a=2{//�����[���Ȃ�`
				;logmes "�ʂ���"
				enemy_info 22,35,42,63
				epos bsize/2,bsize : color 243,0,255
				if enemyl(ecnt)=0{//����ł���
					if edcnt(ecnt)<8{//��莞�ԕ`��
						edcnt(ecnt)++
						if enemydir(ecnt)=0{//������������������`
							celput mainpic(8),enemy_num(a)+(enemy_anip(a)/2)-1
						}
						if enemydir(ecnt)=1{//�����E������������`
							celput mainpic(8),enemy_num(a)+enemy_anip(a)-1
						}
					}
				}
				if enemyl(ecnt)>0{//�����Ă���
					if enemydir(ecnt)=0 & edcheck(ecnt)=0{//������������������`
						celput mainpic(8),enemy_num(a)+((enemy_anipc(ecnt)/20)\((enemy_anip(a)/2)-1))
						ebh 0,0,0,255,0 : d=stat; : logmes "d="+d//���Ƀu���b�N�����邩
						//if d=0 : �u���b�N���Ȃ�������ړ�������
						if d=0{
							if a=1 : exmove(ecnt)=-1.0
							if a=2 : exmove(ecnt)=-2.0
						}
						if ((enemy_anipc(ecnt)/20)\((enemy_anip(a)/2)-1))=0 : exmove(ecnt)=0.0//�����J���ĂȂ��Ƃ��͓����Ȃ�
						
					}
					if enemydir(ecnt)=1 & edcheck(ecnt)=0{//�����E������������`
						celput mainpic(8),enemy_num(a)+((enemy_anipc(ecnt)/20)\((enemy_anip(a)/2)-1))+enemy_anip(a)/2
						ebh 2,0,0,255,0 : d=stat; : logmes "d="+d//�E�Ƀu���b�N�����邩
						if d=0{
							if a=1 : exmove(ecnt)=1.0
							if a=2 : exmove(ecnt)=2.0
						}
						if ((enemy_anipc(ecnt)/20)\((enemy_anip(a)/2)-1))=0 : exmove(ecnt)=0.0//�����J���ĂȂ��Ƃ��͓����Ȃ�
					}
					;���E�ړ�
					repeat abs(exmove(ecnt))
						if exmove(ecnt)<0{//���ֈړ����Ă���
							ebh 0,0,255,0,100 : d=stat; : logmes "d="+d
							if d=0 : enemypx(ecnt)-1
							if d!0 : enemydir(ecnt)=1 : edcheck(ecnt)=1 :  break//������ς���
						}if exmove(ecnt)>0{//�E�ֈړ����Ă���
							ebh 2,0,0,255,100 : d=stat; : logmes "d="+d
							if d=0 : enemypx(ecnt)+1
							if d!0 : enemydir(ecnt)=0 : edcheck(ecnt)=1 : break//������ς���
						}
					loop
					;logmes "enemydir="+enemydir(ecnt)
					;logmes "�I���I"
					;�㉺�ړ�
					ebh 3 : d=stat
					if d=0 : eymove(ecnt)+1//�n�ʂ��Ȃ�������
					if d!0{//�n�ʂ���������
						if enemy_check(ecnt)=0 & ((enemy_anipc(ecnt)/20)\((enemy_anip(a)/2)-1))=1 : eymove(ecnt)=-6//�����J������W�����v������
						enemy_check(ecnt)=((enemy_anipc(ecnt)/20)\((enemy_anip(a)/2)-1))
					}
					repeat abs(eymove(ecnt))
						if eymove(ecnt)<0{//�㏸����������
							ebh 1,0,255,100,255 : d=stat
							if d=0 : enemypy(ecnt)-1
							if d!0 : eymove(ecnt)=0 : break
						}if eymove(ecnt)>0{//���~����������
							ebh 3,0,0,255,255 : d=stat
							if d=0 : enemypy(ecnt)+1
							if d!0 : eymove(ecnt)=0 : break
						}
					loop
					if a=1 : ehitcheck 5,0,1
					if a=2 : ehitcheck 7,0,1
					enemy_anipc(ecnt)++
					if enemyl(cnt)=0 : dmmplay sesound(12)//���S��
				}
			}
*enemy_mouse
			if a=3{//�����l�Y�~�Ȃ�`
				;logmes "�ʂ���"
				epos bsize/2,bsize : color 243,0,255
				if enemyl(ecnt)=0{//����ł���
					if edcnt(ecnt)<8{//��莞�ԕ`��
						edcnt(ecnt)++
						if enemydir(ecnt)=0{//������������������`
							celput mainpic(8),enemy_num(a)+(enemy_anip(a)/2)-1
						}
						if enemydir(ecnt)=1{//�����E������������`
							celput mainpic(8),enemy_num(a)+enemy_anip(a)-1
						}
					}
				}
				if enemyl(ecnt)>0{//�����Ă���
					enemy_info 20,40,43,63
					if enemydir(ecnt)=0 & edcheck(ecnt)=0{//������������������`
						if enemy_mode(ecnt)=0{
							exmove(ecnt)=0.0
							celput mainpic(8),enemy_num(a)+((enemy_anipc(ecnt)/20)\((enemy_anip(a)/2)-1))
							enemypx(ecnt)-0.2 : ebh 0,0,0,255,0 : d=stat; : logmes "d="+d
							//if d=0 : �u���b�N���Ȃ�������ړ�������
							if d!0 : enemydir(ecnt)=1 : enemy(ecnt)+0.2 : edcheck(ecnt)=1
						}
						if enemy_mode(ecnt)=1{
							celput mainpic(8),enemy_num(a)+((enemy_anipc(ecnt)/5)\((enemy_anip(a)/2)-1))
							ebh 0,0,0,255,0 : d=stat; : logmes "d="+d//���Ƀu���b�N�����邩
							//if d=0 : �u���b�N���Ȃ�������ړ�������
							if d=0 : exmove(ecnt)=-4.0
						}
						;�������̍��G
						mapx=int(enemypx(ecnt)-enemy_pos_x1+ebhpx1)/bsize+mapvmv : mapy=int(enemypy(ecnt)-enemy_pos_y1+ebhpy1)/bsize+mapvmv : c=map(mapx,mapy)
						repeat enemycmx(ecnt) : ccnt=cnt : b=0//�i�s�����̃u���b�N�����𒲂ׂ�
							repeat pbhl_str_vol
								if mapx-ccnt-2<mapvmv : break//�͂ݏo��Ȃ璲�ׂȂ�
								if map(mapx-ccnt,mapy)=pbhl_str(cnt) : b=1 : break//��������b=1�ɂ���
							loop
						if b=0{//�u���b�N���Ȃ�����
							;logmes "�G�̍�="+((mapx-ccnt-1)*bsize)+"<=�����̉E="+(px+pbhpx2)+" �G�̉E="+((mapx-ccnt)*bsize)+">�����̍�="+(px+pbhpx1)
							;logmes "�G�̏�="+((mapy-1)*bsize)+"<=�����̉�="+(py+pbhpy2)+" �G�̉�="+((mapy)*bsize)+">�����̏�="+(py+pbhpy1)
							if (mapx-ccnt-1)*bsize<=px+pbhpx2 & (mapx-ccnt)*bsize>px+pbhpx1 & (mapy-1)*bsize<=py+pbhpy2 & (mapy)*bsize>py+pbhpy1{
								enemy_mode(ecnt)=1//�v���C���[��������
								;logmes  "�ڂ̑O�ɂ���ȁI�H"
								break
								}else : enemy_mode(ecnt)=0; : logmes "�ڂ̑O�ɂ��Ȃ��Ȃ�..."//�v���C���[�����Ȃ�������
						}
						if b=1 : break
						loop
					}
					if enemydir(ecnt)=1 & edcheck(ecnt)=0{//�����E������������`
						if enemy_mode(ecnt)=0{
							exmove(ecnt)=0.0
							celput mainpic(8),enemy_num(a)+((enemy_anipc(ecnt)/20)\((enemy_anip(a)/2)-1))+enemy_anip(a)/2
							enemypx(ecnt)+0.2 : ebh 2,0,0,255,0 : d=stat; : logmes "d="+d
							//if d=0 : �u���b�N���Ȃ�������ړ�������
							if d!0 : enemydir(ecnt)=0 : enemy(ecnt)-0.2 : edcheck(ecnt)=1
						}
						if enemy_mode(ecnt)=1{
							celput mainpic(8),enemy_num(a)+((enemy_anipc(ecnt)/5)\((enemy_anip(a)/2)-1))+enemy_anip(a)/2
							ebh 2,0,0,255,0 : d=stat; : logmes "d="+d//���Ƀu���b�N�����邩
							//if d=0 : �u���b�N���Ȃ�������ړ�������
							if d=0 : exmove(ecnt)=4.0
						}
						;�E�����̍��G
						mapx=int(enemypx(ecnt)-enemy_pos_x1+ebhpx2)/bsize+mapvmv : mapy=int(enemypy(ecnt)-enemy_pos_y1+ebhpy1)/bsize+mapvmv : c=map(mapx,mapy)
						if enemypx(ecnt)-enemy_pos_x1+ebhpx2>msx : enemydir(ecnt)=0 : edcheck(ecnt)=1
						repeat enemycmx(ecnt) : ccnt=cnt : b=0//�i�s�����̃u���b�N�����𒲂ׂ�
							repeat pbhr_str_vol
								if mapx+ccnt-1<mapvmv : break//�͂ݏo��Ȃ璲�ׂȂ�
								if map(mapx+ccnt,mapy)=pbhr_str(cnt) : b=1 : break//��������b=1�ɂ���
							loop
						if b=0{//�u���b�N���Ȃ�����
							;logmes "�G�̍�="+((mapx-ccnt)*bsize)+"<=�����̉E="+(px+pbhpx2)+" �G�̉E="+((mapx-ccnt+1)*bsize)+">�����̍�="+(px+pbhpx1)
							;logmes "�G�̏�="+((mapy-1)*bsize)+"<=�����̉�="+(py+pbhpy2)+" �G�̉�="+((mapy)*bsize)+">�����̏�="+(py+pbhpy1)
							if (mapx+ccnt-1)*bsize<=px+pbhpx2 & (mapx+ccnt)*bsize>px+pbhpx1 & (mapy-1)*bsize<=py+pbhpy2 & (mapy)*bsize>py+pbhpy1{
								enemy_mode(ecnt)=1//�v���C���[��������
								;logmes  "�ڂ̑O�ɂ���ȁI�H"
								break
								}else : enemy_mode(ecnt)=0; : logmes "�ڂ̑O�ɂ��Ȃ��Ȃ�..."//�v���C���[�����Ȃ�������
						}
						if b=1 : break
						loop
					}
					;logmes "enemy_mode="+enemy_mode(ecnt)
					;���E�ړ�
					;logmes "exmove="+exmove(ecnt)
					repeat abs(exmove(ecnt))
						if exmove(ecnt)<0{//���ֈړ����Ă���
							ebh 0,0,255,0,100 : d=stat; : logmes "d="+d
							if d=0 : enemypx(ecnt)-1
							if d!0 : enemydir(ecnt)=1 : edcheck(ecnt)=1 : break//������ς���
						}if exmove(ecnt)>0{//�E�ֈړ����Ă���
							ebh 2,0,0,255,100 : d=stat; : logmes "d="+d
							if d=0 : enemypx(ecnt)+1
							if d!0 : enemydir(ecnt)=0 : edcheck(ecnt)=1 : break//������ς���
						}
					loop
					;logmes "enemydir="+enemydir(ecnt)
					;logmes "�I���I"
					;�㉺�ړ�
					ebh 3 : d=stat
					if d=0 : eymove(ecnt)+1//�n�ʂ��Ȃ�������
					repeat abs(eymove(ecnt))
						if eymove(ecnt)<0{//�㏸����������
							ebh 1,0,255,100,255 : d=stat
							if d=0 : enemypy(ecnt)-1
							if d!0 : eymove(ecnt)=0 : break
						}if eymove(ecnt)>0{//���~����������
							ebh 3,0,0,255,255 : d=stat
							if d=0 : enemypy(ecnt)+1
							if d!0 : eymove(ecnt)=0 : break
						}
					loop
					ehitcheck 3,0,1
					enemy_anipc(ecnt)++
					if enemyl(cnt)=0 : dmmplay sesound(12)//���S��
				}
			}
			edcheck(ecnt)=0
		}
		if (enemypx(ecnt)<-wx_move-bsize*5 | -wx_move+gwx+bsize*5<=enemypx(ecnt) | enemypy(ecnt)<-wy_move-bsize*5 | -wy_move+gwy+bsize*5<=enemypy(ecnt)) & enemyl(ecnt)!0{//��ʊO�ɏo�Ă�����Ɨ���ā@���@����łȂ�������
			if -wx_move-bsize*5>fenemypx(ecnt) & fenemypx(ecnt)>=-wx_move+gwx+bsize*5 & -wy_move-bsize*5>fenemypy(ecnt) & fenemypy(ecnt)>=-wy_move+gwy+bsize*5 : enemypx(ecnt)=fenemypx(ecnt) : enemypy(ecnt)=fenemypy(ecnt) : //�����A�ꏊ����ʊO�������猳�̈ʒu�ɖ߂�
		}
	loop
	if canjump=1{
		if space=0 : pymove=-pymovem/2//�W�����v�������
		if space=1 : pymove=-pymovem-2//�W�����v��������
	}
return

*player_draw
		;�`��
	if player_damage_mode=1{
		pdcnt++//player_damage_cnt
		if pdcnt=127 : player_damage_mode=0 : pdcnt=0
	}
	;logmes "pdcnt="+pdcnt
	color 243,0,255 : gmode 4,,,ptrans//�v���C���[��`��
	if pdcnt\4!1{//�_�łɂ��邽��
		if pg=0 | pg=4 :  pos px+wx_move,py+wy_move : celput mainpic(2),pani
		if pg=2 : pos px+wx_move,py+wy_move : celput mainpic(2),pani,,,deg2rad(180)
	}
	if pdeath=1 : return//����ł���`�悾��
	panic++//player_animation_check
		;���E
	;pxymovep_cnt++//�����A�����̂��₷���p
	if hidari=1 & acnt\pxmovep=0 : pxmove-1 : hidarip=1 : if migip=0 : px_direction=0//pxmove--
	if hidari=0 : hidarip=0
	if migi=1 & acnt\pxmovep=0 : pxmove+1 : migip=1 : if hidarip=0 : px_direction=1//pxmove++
	if migi=0 : migip=0
	if (hidari=0 & migi=0) | (hidari=1 & migi=1){
		if pxmove<0 & acnt\pxmovep=0 : pxmove++
		if pxmove>0 & acnt\pxmovep=0 : pxmove--
		if px_direction=0{
			if panic\panipf(0)=0{//�A�j���[�V�����p
				if (pg=0 | pg=4) : pani=loopan(pani,panip(0),panip(1))//��
				if (pg=2) : pani=loopan(pani,panip(1),panip(2))//��
			}
		}if px_direction=1{
			if panic\panipf(0)=0{//�A�j���[�V�����p
				if (pg=0 | pg=4) : pani=loopan(pani,panip(1),panip(2))//��
				if (pg=2) : pani=loopan(pani,panip(0),panip(1))//��
			}
		}
		//logmes "pacheck="+pacheck
	}
	pxmove=limit(pxmove,-pxmovem,pxmovem)//pxmove������
	
	repeat abs(pxmove)
		if pxmove<0{//���Ɉړ�
			pbh 0,0,255,0,255 : a=stat
			if a=0 : px-1//�u���b�N���Ȃ�������ړ�
			if a>0 : px_move=0//�u���b�N���������猸��
			//if a>0 : pxmove+1
		}if pxmove>0{//�E�ړ�
			pbh 2,0,0,255,0 : a=stat
			if a=0 : px+1//�u���b�N���Ȃ�������ړ�
			if a>0 : px_move=0//�u���b�N���������猸��
		}
		px=limit(px,-pbhpx1,msx-pbhpx2)//px������
	loop
	if pxmove<0{//�������̃A�j���[�V����
		if panic\panipf(3)=0{
			if (pg=0 | pg=4){//��
				if pani<panip(2) | panip(4)<=pani : pani=panip(2)//ani:��������
				if pani<panip(3) : pani++
				if panip(3)<=pani & pani<panip(4) : pani=loopan(pani,panip(3),panip(4))//ani:���葱����
			}if (pg=2){//��
				if pani<panip(4) | panip(6)<=pani : pani=panip(4)//ani:��������
				if pani<panip(5) : pani++
				if panip(5)<=pani & pani<panip(6) : pani=loopan(pani,panip(5),panip(6))//ani:���葱����
			}
		}
	}if pxmove>0{//�E�����̃A�j���[�V����
		if panic\panipf(3)=0{
			if (pg=0 | pg=4){//��
				if pani<panip(4) | panip(6)<=pani : pani=panip(4)//ani:��������
				if pani<panip(5) : pani++
				if panip(5)<=pani & pani<panip(6) : pani=loopan(pani,panip(5),panip(6))//ani:���葱����
			}if (pg=2){//��
				if pani<panip(2) | panip(4)<=pani : pani=panip(2)//ani:��������
				if pani<panip(3) : pani++
				if panip(3)<=pani & pani<panip(4) : pani=loopan(pani,panip(3),panip(4))//ani:���葱����
			}
		}
	}

	//logmes "pani="+pani
		;�㉺
	;�W�����v
	if pswim=0{
		;logmes "spacep="+spacep
		if space=1 & spacep=0{
			;logmes "�W�����v����
			spacep=1 : dmmplay sesound(7)
			if pymove>0 : pymove=0
			repeat pymovem
				getkey spacea,32
				if spacea=1 & pymove>-pymovem : pymove-1
			loop
		}
		;�d��
		if (pg=0 | pg=4){//��
			pbh 3,0,255,0,0 : a=stat
			;logmes "�n�ʂ̃��^�[���l="+a
			if a=0 & pymove<pymovem  & acnt\pymovep=0{//�n�ʂ��Ȃ�������
				if pg=0 & pymove<pymovem : pymove+1
				if pg=4 & pymove<pymovem : pymove+2
				if spacep=1{
					if pxmove<0 : pani=panip(6)//�W�����v���̃A�j���[�V����(��)
					if pxmove>0 : pani=panip(7)//(�E)
				}
			}if a>0{
				;dmmplay sesound(9)
				spacep=0//�ăW�����v�\��
			}//�ăW�����v�\��
		}if pg=2{//��
			pbh 1,0,255,0,0 : a=stat
			if a=0 & pymove<pymovem{//�n�ʂ��Ȃ�������
				if pymove<pymovem : pymove+1
				if spacep=1{
					if pxmove<0 : pani=panip(7)//�W�����v���̃A�j���[�V����(��)
					if pxmove>0 : pani=panip(6)//(�E)
				}
			}if a>0{
				;if pymove!0 : dmmplay sesound(9)
				spacep=0//�ăW�����v�\��
			}
		}
	}if pswim=1{
		if space=1 & spacep=0{
			dmmplay sesound(16) : spacep=1
			repeat pymovem/3
				getkey space,32
				if space=1 & pymove>-pymovem : pymove-1
				;logmes "pymovre="+pymove
			;await 1
			loop
		}
		pbh 3,0,255,0,0 : a=stat
		;logmes "�n�ʂ̃��^�[���l="+a
		if a=0 & pymove<pymovem/4  & acnt\pymovep=0{//�n�ʂ��Ȃ�������
			if pymove<pymovem : pymove+1
			if spacep=1{
				if pxmove<0 : pani=panip(6)//�W�����v���̃A�j���[�V����(��)
				if pxmove>0 : pani=panip(7)//(�E)
			}
		}if space=0 : spacep=0
	}
	
	;logmes "pymove="+pymove
	repeat abs(pymove)//�㏸�A���~�񐔕����s�[�g
		if (pg=0 | pg=4){
			if pymove<0{//�㏸����������
				pbh 1,0,100,10,255 : a=stat
				if a=0 : py-1
				if a>0 : pymove=0 : break//�����ɂԂ������痎��������
			}
			if pymove>0{//���~����������
				pbh 3,0,255,0,0 : a=stat
				if a=0 : py+1//�n�ʂ��Ȃ�������
				if a>0 : pymove=0 : break//�n�ʂ���������
			}
		}
		if (pg=2){
			if pymove<0{//�㏸����������
				pbh 3,0,100,10,255 : a=stat
				if a=0 : py+1
				if a>0 : pymove=0 : break//�����ɂԂ������痎��������
			}
			if pymove>0{//���~����������
				pbh 1,0,255,0,0 : a=stat
				if a=0 : py-1//�n�ʂ��Ȃ�������
				if a>0 : pymove=0 : break//�n�ʂ���������
			}
		}
		;pymove=limit(pymove,-pymovem,pymovem)//pymove������
	loop
	py=limit(py,-psizey-bsize,msy+psizey)//py������
	//py=limit(py,0,msy)
	pbh 4,0,255,255,0
return

*player_UI
	drphit_damage
	;HP�o�[
	color 255,100,100 : boxf 32,0,32+limit(double(player_hp)/player_hpm*167,0,200),19//HP�̃o�[
	player_hp=limit(player_hp,0,player_hpm)
	color 243,0,255 : gmode 4,,,255 : pos 0,0 : celput mainpic(11)//HP�̉摜
	font "",14
	color 0,0,0 : pos 202,4 : mes ""+player_hp+"/"+player_hpm
	;�����J�E���^�[
	gmode 0 : pos 250,0 : celput mainpic(14) : pos 380,4 : mes kodama_vol
	
return

*pose_menu
	bb=0
	repeat
		redraw 1 : redraw 0
		color 243,0,255 : gmode 4,,,cnt : pos 0,0 : celput mainpic(15)
		gmode 4,,,limit(cnt,0,100) : pos 0,0 : celput mainpic(16)
		pos 0,0 : celput mainpic(17)

		gosub*keycontrol
		if ue=1 : bb=0
		if sita=1 : bb=1
		ga=ginfo_act
		if (360<moux & moux<672 & 192<mouy & mouy<288) & ga!-1 & check=0 : bb=0 : check=1 : if lclick=1 : break
		if (352<moux & moux<672 & 352<mouy & mouy<448) & ga!-1 & check=0 : bb=1 : check=1 : if lclick=1 : break
		if bb=0 : color 243,0,255 : gmode 4,,,limit(cnt,0,255) : pos 0,0 : celput mainpic(16)
		if bb=1 : color 243,0,255 : gmode 4,,,limit(cnt,0,255) : pos 0,0 : celput mainpic(17)
		if enter=1 & ga!-1 : break
		check=0
		await 16
	loop
	if bb=1{
		if play_mode=0 : vs_nest=1 : back_to_select=1
		if play_mode=1 : vs_nest=1 : back_to_select=1
		if play_mode=2{
			if stage_map_name="" : vs_nest=1 : back_to_select=1
			if stage_map_name!"" : vs_nest=1 : back_to_select=2
			logmes "back"+back_to_select
		}
	}
return

*get_big_soul
	gmode 2 : pos px+pbhpx1,py+pbhpy-400 : celput effepic(4),acnt\250
return

*player_mode
	if pg=0{//�ʏ�
		if pmode=0 : pbh_info 17,5,40,64
	}
	if pg=1{//��
		if pmode=0 : pbh_info 17,5,40,64
	}
	if pg=2{//��
		if pmode=0 : pbh_info -17,-5,-40,-64
	}
	if pg=3{//�E
		if pmode=0 : pbh_info 17,5,40,64
	}
	if pg=4{//��
		if pmode=0 : pbh_info 17,5,40,64
	}
	//logmes "px="+px+" py="+py
return

*pdeath_check
	if py>msy | player_hp=0 : pdeath=1 : vs_nest=1
return

*stage_clear
	dmmstop -1//���y��~
	dmmplay sesound(3)
	a=0//�w�i��\��������t���[�g��
	gosub*map_draw : gosub*player_draw : gosub*player_UI
	repeat
		redraw 1 : redraw 0
		acnt=cnt
		if (cnt-a)*14-gwx*2<gwx : color 0,0,0 : gmode 4,,,5-acnt/60 : pos (goalx-mapvmv)*bsize+wx_move,(goaly-mapvmv)*bsize+wy_move : celput effepic(0),(acnt/2)\200//�ڂ������
		color 255,255,255 : gmode 4,,,10 : pos (cnt-a)*14-gwx*3,0 : celput mainpic(4)//�O���f�[�V�����w�i
		if (cnt-a)*14-gwx*4>gwx : break//�O���f�[�V��������ʑ�ɏo����X�e�[�W�I����ʂ�
		if (cnt-a)*14-gwx*3>=gwx : color 0,0,0 :gmode 2
		
		gosub*keycontrol
		if space=1 : break
		await 16
	loop
	if play_mode=0{
		;px=fpx : py=fpy//�����ʒu�ɖ߂�
		play_mode=1 : mload_mode=3 : gosub*map_load : goto*play_select
	}
	if play_mode=2{
		if first_story=1 : first_story=2
		akodama_vol+=kodama_vol
		kodama_vol=0
		wx_move=gwx/2-px : wy_move=gwy/2-py : goto*stage_select_main
	}
*menu_death
	dmmstop -1//���y��~
	dmmplay sesound(2)//���S��
	sflame=120//start_flame//BGM�𗬂��t���[����
	bb=0 : player_damage_mode=0 : pdcnt=0 : kodama_vol=0 : pswim=0 : pymovep=1
	repeat
		redraw 1 : redraw 0
		if cnt=sflame : dmmplay bgmsound(2)//���S��BGM�Đ�
		if cnt<sflame{
			gosub*map_draw
			gosub*enemy_draw
			;logmes ""+(sflame/panipc(8))
			if px_direction=0 : pani=panip(8)+cnt/(sflame/panipc(8))
			if px_direction=1 : pani=panip(9)+cnt/(sflame/panipc(9))
			gosub*player_draw�@: ptrans-1
			gosub*player_UI
		}
		if cnt>sflame{
			gmode 3,,,(cnt-a)/5 : pos 0,0 : celput mainpic(3)
			color 243,0,255 : gmode 4,,,limit((cnt-a)/5,0,50) : pos 0,0 : celput mainpic(6) : pos 0,0 : celput mainpic(7)
			gosub*keycontrol
			if hidari=1 : bb=0
			if migi=1 : bb=1
		}

		ga=ginfo_act
		if (110<moux & moux<430 & 380<mouy & mouy<550) & ga!-1 & check=0 : bb=0 : check=1 : if lclick=1 : break
		if (570<moux & moux<880 & 380<mouy & mouy<550) & ga!-1 & check=0 : bb=1 : check=1 : if lclick=1 : break
		if bb=0 : color 243,0,255 : gmode 4,,,(cnt-a)/5 : pos 0,0 : celput mainpic(6)
		if bb=1 : color 243,0,255 : gmode 4,,,(cnt-a)/5 : pos 0,0 : celput mainpic(7)
		if enter=1 & ga!-1  : break
		check=0
		await 16
	loop
	if px_direction=0 : pani=panip(0)
		if px_direction=1 : pani=panip(1)
	ptrans=255 : dmmstop -1
	if bb=0{
		if play_mode=0 : px=fpx : py=fpy : mload_mode=3 : gosub*map_load : gosub*map_bgm : goto*main//���������V��
		if play_mode=2 : mload_mode=1 : gosub*map_load : gosub*map_bgm : goto*main
	}
	if bb=1{//������
		if play_mode=0 : play_mode=1 : mload_mode=3 : gosub*map_load : gosub *map_bgm : wait 10 : wx_move=gwx/2-px : wy_move=gwy/2-py : goto*play_select//��郂�[�h�ɕς���
		if play_mode=2{
			repeat 64 : redraw 1 : redraw 0 : pos 0,0 : celput mainpic(3) : black_inout cnt,0 : loop
			wx_move=gwx/2-px : wy_move=gwy/2-py : goto*stage_select_main
			
		}
	}

*mplayer_draw
	if lclick=1 & phold=0 & (px+pbhpx1)+wx_move<=moux & moux<(px+pbhpx2)+wx_move & (py+pbhpy1)+wy_move<=mouy & mouy<(py+pbhpy2)+wy_move : phold=1
	if phold=1 & lclick=0 : phold=0
	if phold=1{
		px=moux-wx_move-pbhpx1-psizex/2 : py=mouy-wy_move-pbhpy1-psizey/2
	}
	px=limit(px,-pbhpx1,msx-pbhpx2) : py=limit(py,-pbhpy1,msy-pbhpx2)//����
	color 243,0,255 : gmode 4,,,255
	pos px+wx_move,py+wy_move : celput mainpic(2),pani//�v���C���[��`��
return

*makeUI//!!////////////////UI�����͒萔����������ύX����ۂ͒��ӁI�I///////////////////////!!//
		;�E����UI
	;���
		if mouw>0 : sUI-1//�}�E�X�z�C�[��
		if mouw<0 : sUI+1//�}�E�X�z�C�[��
		if 710<=moux & moux<970 & 0<=mouy & mouy<=14 & phold=0{
		if lclick=1{
			if 710<=moux & moux<800 : sUI=0
			if 800<=moux & moux<890 : sUI=1
			if 890<=moux & moux<980 : sUI=2
		}
	}sUI=limit(sUI,0,2)//select_UI
	color 243,0,255 : gmode 4,,,230
	if sUI=0 : pos bsize*22,0 : celput makepic(0)
	if sUI=1 : pos bsize*22,0 : celput makepic(1)
	if sUI=2 : pos bsize*22,0 : celput makepic(2)
	;�u���b�N
	color 243,0,255 : gmode 4,,,255
	if sUI=0{
		if sb_mode!0 : sb_mode=0 : sblock=block_str(0) : select_target=0 : sblock=cblock_str(0)
		repeat cblock_num_vol+block_mnum_vol
			pos 736+(cnt\8)*bsize,32+(cnt/8)*bsize
			if cnt<cblock_num_vol{
				celput mainpic(0),cblock_num(cnt)//connect�u���b�N��UI�ɔz�u
				if lclick=1 & 736+(cnt\8)*bsize<=moux & moux<736+((cnt\8)+1)*bsize & 32+(cnt/8)*bsize<=mouy & mouy<32+((cnt/8)+1)*bsize{//�����u���b�N��I��ł�����
					sblock=cblock_str(cnt) : select_target=cnt
					//logmes "�I�������u���b�N��"+sblock
					sb_mode=0
				}
			}
			if cblock_num_vol<=cnt{
				celput mainpic(1),block_mnum(cnt-cblock_num_vol)//���ʂ̃u���b�N��UI�ɔz�u
				if lclick=1 & 736+(cnt\8)*bsize<=moux & moux<736+((cnt\8)+1)*bsize & 32+(cnt/8)*bsize<=mouy & mouy<32+((cnt/8)+1)*bsize{//�����u���b�N��I��ł�����
					sblock=block_mstr(cnt-cblock_num_vol) : select_target=cnt
					//logmes "�I�������u���b�N��"+sblock
				}
			}
		loop
	}
	;�ق��̃u���b�N
	if sUI=1{
		if sb_mode!1 : sb_mode=1 : sblock=oblock_str(0) : select_target=0 : sblock=oblock_str(0)
		repeat oblock_num_vol
			//logmes "cnt="+cnt
			pos 736+(cnt\8)*bsize,32+(cnt/8)*bsize
			celput mainpic(5),oblock_num(cnt)//���ʂ̃u���b�N��UI�ɔz�u
			if lclick=1 & 736+(cnt\8)*bsize<=moux & moux<736+((cnt\8)+1)*bsize & 32+(cnt/8)*bsize<=mouy & mouy<32+((cnt/8)+1)*bsize{//�����u���b�N��I��ł�����
				sblock=oblock_str(cnt) : select_target=cnt
				//logmes "�I�������u���b�N��"+sblock
			}
		loop
	}
	;�G
	if sUI=2{
		if sb_mode!2 : sb_mode=2 : sblock=oblock_str(0) : select_target=0 : sblock=enemy_str(0)
		repeat enemy_mnum_vol
			pos 736+(cnt\8)*bsize-bsize/2,32+(cnt/8)*bsize-bsize//������Ƃ��炵�Ĕz�u�i����64*64������j
			celput mainpic(8),enemy_num(cnt)//���ʂ̃u���b�N��UI�ɔz�u
			if lclick=1 & 736+(cnt\8)*bsize<=moux & moux<736+((cnt\8)+1)*bsize & 32+(cnt/8)*bsize<=mouy & mouy<32+((cnt/8)+1)*bsize{//�����u���b�N��I��ł�����
				sblock=enemy_str(cnt) : select_target=cnt
				//logmes "�I�������G��"+sblock
			}
		loop
	}
	color acnt*3,acnt*3,acnt*3
	boxline 736+(select_target\8)*bsize,32+(select_target/8)*bsize,736+(select_target\8+1)*bsize-1,32+(select_target/8+1)*bsize-1//�I�������u���b�N�ɓ_�ł���g��\��
	
	;mx,my��ύX//repeat-loop�O�ŋL��
	//pos 730,492 : input mx,40,20,3 : pos 730,535 : input my,40,20,3//���̋L�����e
	font "",15
	color 0,0,0 : pos 730,480 : mes "���T�C�Y" : color 0,0,0 : pos 730,518 : mes "�c�T�C�Y"
	pos 800,510 : mes "F3��\n  ���[�h�ؑ�"
	;�{�^��
	ssmenu 0//button�\��
	a=stat
	//logmes "a="+a
	if phold=0{
		if a=0 : menu=1 : vs_nest=1//�ǂݍ���
		if a=1 : menu=2 : vs_nest=1//���O��t���ĕۑ�
		if a=2 : menu=3 : vs_nest=1//�㏑���ۑ�
		if a=3{//��ʂ̐^�񒆂ɍĕ\��
			px=gwx/2-wx_move : py=gwy/2-wy_move
			if px_direction=0 : pani=panip(0)
			if px_direction=1 : pani=panip(1)
		}
		if a=4{//�܂�����ɂ���
			menu=4 : vs_nest=1
			if px_direction=0 : pani=panip(0)
			if px_direction=1 : pani=panip(1)
		}
	}
return

*anything_set
	ga=ginfo_act
	repeat my
		ycnt=cnt
		repeat mx
			xcnt=cnt : check=0
			//logmes "x="+(bsize*xcnt)+"�`"+(bsize*(xcnt+1))
			if bsize*xcnt+wx_move<=moux & moux<bsize*(xcnt+1)+wx_move & bsize*ycnt+wy_move<=mouy & mouy<bsize*(ycnt+1)+wy_move & moux<=710 & ga!-1{//���̘g���Ł`
				if lclick=1 & check=0 & phold=0{//���N���b�N+�v���C���[�z�[���h���ĂȂ���Ԃ�������
					mapx=xcnt+mapvmv : mapy=ycnt+mapvmv
					if sb_mode=0{//�u���b�N
						c=map(mapx,mapy)
						;logmes "�ݒu����x="+mapx+" y="+mapy
						if fill_mode=0 & c!sblock{//���ʂɐݒu
							if sblock="b(3)" : map(goalx,goaly)="0" : goalx=mapx : goaly=mapy//�S�[���͈�����u���Ȃ��悤��
							dmmplay sesound(0) :map(mapx,mapy)=sblock//�ݒu
							//if omap(mapx,mapy)!"0" : omap(mapx,mapy)="0"
							;logmes "�ݒu�����u���b�N��"+sblock+"�ł�
						}
						if fill_mode=1 & c!sblock & sblock!"b(3)" : anything_fill sblock//�h��Ԃ����[�h��������
					}
					if sb_mode=1{//���̑��u���b�N
						;logmes "�ݒu����x="+mapx+" y="+mapy
						c=omap(mapx,mapy)
						if fill_mode=0 & c!sblock{//���ʂɐݒu
							dmmplay sesound(0) : omap(mapx,mapy)=sblock//�ݒu
							;logmes "�ݒu�����u���b�N��"+sblock+"�ł�
						}
						if fill_mode=1 & c!sblock : anything_fill sblock//�h��Ԃ����[�h��������
					}
					if sb_mode=2{//�G
						;logmes "�ݒu����x="+mapx+" y="+mapy
						c=emap(mapx,mapy)
						if map(mapx,mapy)!"0" : map(mapx,mapy)="0"
						if omap(mapx,mapy)!"0" : omap(mapx,mapy)="0"
						if c!sblock : dmmplay sesound(0) : emap(mapx,mapy)=sblock : lclickp=1; : logmes "�ݒu�����G��"+sblock+"�ł�//�ݒu
						if c=sblock & lclickp=0 : dmmplay sesound(15) : edmap(mapx,mapy)++ : lclickp=1//�ݒu
					}
					map_change=1
				}if lclick=0 : lclickp=0
				if rclick=1{//�E�N���b�N���ꂽ��
					mapx=xcnt+mapvmv : mapy=ycnt+mapvmv : check=0
					//logmes "�폜����x="+mapx+" y="+mapy
					if sb_mode=0 : c=map(mapx,mapy)
					if sb_mode=1 : c=omap(mapx,mapy)
					if sb_mode=2 : c=emap(mapx,mapy)
					if fill_mode=0{
						;logmes "c="+c
						if sb_mode=0 & c!"0" : map(mapx,mapy)="0" : check=1
						if sb_mode=1 & c!"0" : omap(mapx,mapy)="0" : check=1
						if sb_mode=2 & c!"0" : emap(mapx,mapy)="0" : edmap(mapx,mapy)=0 : check=1
						if check=1 : dmmplay sesound(1)
						
					}
					if fill_mode=1 & c!"0" : anything_fill "0"//�h��Ԃ����[�h��������
					map_change=1
				}
			}
		loop
	loop
return

*clean_map
	;logmes "�}�b�v����|���܂���"
	mapdata="" : mapinfo="" : omapdata="" : emapdata=""
	repeat mymax
		ycnt=cnt+mapvmv
		repeat mxmax
			xcnt=cnt+mapvmv
			map(xcnt,ycnt)="0" : animap(xcnt,ycnt)=0 : animapc(xcnt,ycnt)=0
			omap(xcnt,ycnt)="0"
			emap(xcnt,ycnt)="0" : edmap(xcnt,ycnt)=0 : ecmxmap(xcnt,ycnt)=0 : ecmymap(xcnt,ycnt)=0
		loop
	loop
	goalx=0 : goaly=0
return

*map_load//�}�b�v�ǂݍ���
		;�ǂݍ���
	;�t�H���_����
	if mload_mode=-1 : gosub*clean_map : return//�����ǂݍ��܂Ȃ�
	if mload_mode=0 : fname="map/new"//�ŏ��ɓǂݍ��݃t�@�C�����w�肵�Ȃ��ꍇ
	if mload_mode=1 : fname="map/stage_select/"+stage+"/"+stage_map_name//�ŏ�����I������ꍇ
	if mload_mode=2{
		dialog "phs",16
		if stat=0 : mload_mode=3 : black_mode=0 : wait 10 : return// : dialog "�ǂݍ��݂Ɏ��s�����������...",0
		a=refstr
		repeat//�t�H���_��������
		if strmid(a,cnt,11)="Clickme.phs" : fname=strmid(a,0,cnt-1) : break//�I������ꍇ��fname
		loop
		gosub*clean_map//�����ǂݍ��߂���}�b�v�����Z�b�g
	}
	if mload_mode=3 : ffname=fname : fname="temp"//temp�t�@�C��
	;if mload_mode=4//���O�Ɏw�肵��fname��ǂݍ���
	;�X�e�[�W���
	if mload_mode!3{
		mapinfo="" : notesel mapinfo
		logmes fname+"/info.txt��ǂݍ���"
		noteload fname+"/info.txt" : a=0
		noteget mx,a : a++ : noteget my,a : a++ : noteget px,a : a++ : noteget py,a : a++
		mx=int(mx) : my=int(my) : fpx=int(px) : fpy=int(py) : px=int(px) : py=int(py)
	}
	;logmes fname+"�ǂݍ���"
	;�u���b�N
	notesel mapdata//�o�b�t�@�w��
	noteload fname+"/stage.txt"
	c=""
	repeat my
		//redraw 0 : drawc=1//�ǂݍ��ݕ��i��`�悷��@
		ycnt=cnt : xload=0
		noteget a,ycnt//a�Ɉꎞ�I�ɂ��̍s�̓��e��������
		;logmes ""+ycnt+"�s��="+a
		repeat mx
			xcnt=cnt
			b=strmid(a,xload,1)//b:�m�F�p�Ɉꎞ�I�ɓ����
			c=b//�����Ȃ���΋�C//c:�ŏI�I��map(mx,my)�ɑ������
			
			if (b="a" | b="b"){//�J�b�R���̓z��������
				repeat
					ccnt=cnt//�������ڂ܂Ő��������A�������
					if strmid(a,xload+ccnt+2,1)=")" : break
				loop
				c=strmid(a,xload,ccnt+3) : xload+ccnt+2
				if c="b(3)" : goalx=xcnt+mapvmv : goaly=ycnt+mapvmv//�S�[������������W��o�^
			}
			map(xcnt+mapvmv,ycnt+mapvmv)=c//�u���b�N������
			xload++
			if drawc=1 : pos bsize*xcnt,bsize*ycnt : color 0,0,0 : mes c
			//logmes ""+ycnt+"�s�ڂ�"+xcnt+"������="+c
			//redraw 1 : await 10//�ǂݍ��ݕ��i��`�悷��A
		loop
		//redraw 1 : await 50//�ǂݍ��ݕ��i��`�悷��A
	loop
	
	;���̑��Ԃ����
	omapdata=""
	notesel omapdata//�o�b�t�@�w��
	noteload fname+"/ostage.txt"
	repeat my : ycnt=cnt : xload=0 : noteget a,ycnt : repeat mx : xcnt=cnt : b=strmid(a,xload,1) : c=b
		if b="c"{
			repeat ccnt=cnt : if strmid(a,xload+ccnt+2,1)=")" : break : loop
			c=strmid(a,xload,ccnt+3) : xload+ccnt+2
		}omap(xcnt+mapvmv,ycnt+mapvmv)=c : xload++
	loop : loop

	;�G
	emapdata=""
	notesel emapdata//�o�b�t�@�w��
	noteload fname+"/estage.txt"
		nm=notemax : xload=0 : enemy_vol=0
		;gosub *enemy_dim
		repeat nm//�s�����f�[�^�[�ǂݍ���
			ycnt=cnt : xload=0
			noteget a,ycnt//ycnt�s�ڂ̓��e��a�ɑ��
			;logmes "a="+a
			repeat 6//��̕��̃f�[�^�[
				ccnt=cnt : c=strmid(a,xload,1)
				;logmes c
				if ccnt=0 & c=";" : break//�ǂݍ��܂Ȃ�
				repeat
					c=strmid(a,xload+(cnt+1),1)
					if c="," : edata(ccnt)=int(strmid(a,xload,cnt+2)) : xload+cnt+2 : break
					if c="" : ccnt=5 : edata(ccnt)=int(strmid(a,xload,cnt+2)) :: break
				loop
			loop
			;logmes "number="+edata(0)+" direction="+edata(1)+" posx="+edata(2)+" posy="+edata(3)+" canmovex="+edata(4)+" canmovey="+edata(5)
			;logmes "play_mode="+play_mode
			if play_mode=1{//��郂�[�h��������
				;logmes "�ʂ���"
				edata(2)=limit(edata(2),mapvmv,mx+mapvmv) : edata(3)=limit(edata(3),mapvmv,my+mapvmv)//���������
				mapx=edata(2)+mapvmv : mapy=edata(3)+mapvmv//�o�^����}�X
				emap(mapx,mapy)="e("+edata(0)+")" : edmap(mapx,mapy)=edata(1) : ecmxmap(mapx,mapy)=edata(4) : ecmymap(mapx,mapy)=edata(5)//�G�̎�ނƂ�
				;logmes "�ǂݍ��ݎ���emap="+emap(mapx,mapy)
			}if play_mode=0 | play_mode=2 : mkenemy edata.0,edata.1,edata.2,edata.3,edata.4,edata.5//�V�ԃ��[�h��������
		loop
		if mload_mode=3 : fpx=px : fpy=py : fname=ffname
		;mload_mode=4
return

*map_save
	;logmes "msave_move="+msave_mode
	;�ʏ�u���b�N
	mapdata="" : mapinfo="" : omapdata="" : emapdata="" : notesel mapdata 
	goalcheck=0//�S�[���̗L�����m�F
	repeat my
		ycnt=cnt+mapvmv : mapd=""
		repeat mx
			xcnt=cnt+mapvmv
			c=map(xcnt,ycnt)
			mapd+=c
			if c="b(3)" : goalcheck=1 : goalx=xcnt : goaly=ycnt; : logmes "goalx="+goalx+" goaly="+goaly//�S�[��������������W��ۑ�
		loop
		noteadd mapd,-1,0
	loop
	
	if goalcheck=0 : dialog "���U�i�S�[���j���ݒu����Ă��܂���",1 : black_mode=0 : wait 10 : goto*mmain//�S�[�����Ȃ�������ۑ������Ȃ�
	if msave_mode=0{
		fffname=ffname
		dialog "phs",17 : ffname=refstr : a=stat//���O��t���ĕۑ�
		if a=0 : wait 10 : black_mode=0 : ffname=fffname : msave_mode=check : goto*mmain//: dialog "�ۑ��Ɏ��s������^��^",1 : //�ۑ��Ɏ��s������
		if a!0{//�ۑ��ɐ���������`
			;ffname�̌���"/Clickme.phs"���Ȃ����exist�ɂ��āA�Ȃ���΂��Ȃ��ŕۑ�
			d=strmid(ffname,-1,11)
			if d="Clickme.phs"{
				;logmes "���ׂ��t�@�C����"+ffname
				exist ffname : c=strsize
			}if d!"Clickme.phs"{
				;logmes "���ׂ��t�@�C����"+ffname+"/Clickme.phs"
				exist ffname+"/Clickme.phs" : c=strsize
			}
			
			if c=-1 : mkdir ffname : fname=ffname : bsave ""+fname+"/Clickme.phs",b//�t�H���_���Ȃ���������
			if c!-1{//�t�H���_����������
				if stat=7 : return//�u�������v�����ǂ�
				repeat//�u�͂��v���t�H���_��������
					if strmid(ffname,cnt,11)="Clickme.phs" : fname=strmid(ffname,0,cnt-1) : break
				loop
				bsave ""+fname+"/Clickme.phs",b
			}
		}
	}
	if msave_mode=1//�㏑���ۑ�
	if msave_mode=2{//temp�ۑ�
		fffname=fname
		fname="temp"
		exist fname+"/Clickme.phs" : a=strsize; : logmes "temp�̃t�@�C���T�C�Y="+a
		;logmes "fname="+fname+"��ۑ�"
		if a=-1 : mkdir fname : bsave ""+fname+"/Clickme.phs",b//�t�H���_���Ȃ���������
	}
		
		;logmes fname+"/stage.txt��ۑ�"
		notesave fname+"/stage.txt"
		;���̑��u���b�N
		notesel omapdata
		repeat my : ycnt=cnt+mapvmv : mapd="" : repeat mx : xcnt=cnt+mapvmv
			c=omap(xcnt,ycnt)
			mapd+=c
		loop : noteadd mapd,-1,0 :  loop : notesave fname+"/ostage.txt"
		
		;�G
		notesel emapdata//�G�̏����e�L�X�g��
		enemy_vol=0
		repeat my : ycnt=cnt+mapvmv : repeat mx
				mapd=""
				mapx=cnt+mapvmv : mapy=ycnt+mapvmv
				c=emap(mapx,mapy)
				if c!"0"{
					repeat//�J�b�R�̒��̐���������
						ccnt=cnt
						a=strmid(c,2+ccnt,1)//a:�ꎞ�I
						if a=")" : break
					loop
					b=int(strmid(c,2,ccnt))//b:�ꎞ�I��()�̒��̐�������
					if b=0 | b=1 | b=2 | b=3{
						mapd=""+b+","+edmap(mapx,mapy)+","+(mapx-mapvmv)+","+(mapy-mapvmv)+",10,5"//������������݂̂̓G
					}/*if {
						maped="1,"+c+","+edmap(mapx,mapy)\2+","+mapx+","+mapy+",100,100"//���������ނ̓G
					}if c={
						maped="1,"+c+","+edmap(mapx,mapy)\4+","+mapx+","+mapy+",100,100"//�������l��ނ̓G
					}*/
					
					noteadd mapd,-1,0
					enemy_vol++
				}
			loop
		loop
		;logmes fname+"/estage.txt"
		notesave fname+"/estage.txt"
		
		;�}�b�v�̏��
		notesel mapinfo : a=0
		noteadd str(mx),a : a++
		noteadd str(my),a : a++
		noteadd str(px),a : a++//first_px
		noteadd str(py),a : a++//first_py
		notesave fname+"/info.txt"

		if msave_mode=2 : fname=fffname//temp�������猳�̖��O�ɖ߂�
		if msave_mode!2 : map_change=0
		return
	/*if play_mode=0 : return//�V�ԃ��[�h��������(temp�փZ�[�u)
	if play_mode=1{//��郂�[�h��������
		;dialog "�V�т܂���",2//����E�B���h�E
		if stat=6 : play_mode=0 : return//�͂�
		return//������
	}*/
	

#deffunc pbh_info int player_block_hit_px1, int player_block_hit_py1, int player_block_hit_px2, int player_block_hit_py2//�v���C���[�̓����蔻����l�p�`�œo�^����
	pbhpx1=player_block_hit_px1 : pbhpy1=player_block_hit_py1 : pbhpx2=player_block_hit_px2 : pbhpy2=player_block_hit_py2//����x,y:�E��x,y
	if pbhpx2<pbhpx1 : pbhpx2=player_block_hit_px1 : pbhpx1=player_block_hit_px2//�������ق���pbhpx1�ɁA�傫���ق���pbhpx2�ɑ������
	if pbhpy2<pbhpy1 : pbhpy2=player_block_hit_py1 : pbhpy1=player_block_hit_py2//�������ق���pbhpy1�ɁA�傫���ق���pbhpy2�ɑ������
	psizex=abs(pbhpx2-pbhpx1) : psizey=abs(pbhpy2-pbhpy1)//�v���C���[�̃T�C�Y
return

#deffunc pbh int pblock_hit_direction, int pbh_setline, int pbh_setline_r, int pbh_setline_g, int pbh_setline_b//pcheck:������ʒu���璲�ׂ�}�X��
	if pbh_setline=1 : color pbh_setline_r,pbh_setline_g,pbh_setline_b//���̐F
	a=pblock_hit_direction : d=0
	if -pbhpx1<=px & px<=msx-pbhpx2{//x���W����ʂ���o�ĂȂ���Γ����蔻����m�F����
		if a=0{//��
			repeat (psizey-2)/pbh_cless
				ycnt=cnt*pbh_cless
				mapx=(px+pbhpx1-1)/bsize+mapvmv : mapy=limit((py+ycnt+pbhpy1+1)/bsize+mapvmv,mapvmv,mymax+mapvmv) : b=0 : c=map(mapx,mapy)//mapy��+1�͏�Ɖ��̔��胉�C���Ɣ��Ȃ��悤��
				if pbh_setline=1 : pset (px+pbhpx1-1)+wx_move,(py+ycnt+pbhpy1+1)+wy_move//�m�F�p�ɓ����蔻��̐�������
				repeat pbhl_str_vol//�����蔻��̂���u���b�N�������ׂ�
					if c=pbhl_str(cnt) : b=1 : break
				loop
				if b=1 : d++//���������Ԃ���u���b�N����������c�ɂ��̐���������
				gosub*pbh_kyotu
			loop
		}
		if a=1{//��
			repeat psizex/pbh_cless
				xcnt=cnt*pbh_cless
				mapx=(px+xcnt+pbhpx1)/bsize+mapvmv : mapy=limit((py+pbhpy1)/bsize+mapvmv,mapvmv,mymax+mapvmv) : b=0 : c=map(mapx,mapy)
				if pbh_setline=1 : pset (px+xcnt+pbhpx1)+wx_move,(py+pbhpy1)+wy_move//�m�F�p�ɓ����蔻��̐�������
				repeat pbhu_str_vol//�����蔻��̂���u���b�N�������ׂ�
					if c=pbhu_str(cnt) : b=1 : break// : logmes "�������������I"
				loop
				if b=1{
					d++//���������Ԃ���u���b�N����������c�ɂ��̐���������
					if c="b(19)" | c="b(20)" | c="b(21)" | c="b(22)"{
						dmmplay sesound(28)
						if c="b(20)" : kodama_vol++ : dmmplay sesound(5)
						if c="b(21)" : player_hp+5 : dmmplay sesound(27)
						map(mapx,mapy)="b(22)"
					}
					if c="b(23)" : dmmplay sesound(29) : map(mapx,mapy)="0" : mkphit_damage 1
				}
						
				gosub*pbh_kyotu
			loop
		}
		if a=2{//�E
			repeat (psizey-2)/pbh_cless
				ycnt=cnt*pbh_cless
				mapx=(px+pbhpx2+1)/bsize+mapvmv : mapy=limit((py+ycnt+pbhpy1+1)/bsize+mapvmv,mapvmv,mymax+mapvmv) : b=0 : c=map(mapx,mapy)//mapy��+1�͏�Ɖ��̔��胉�C���Ɣ��Ȃ��悤��
				if pbh_setline=1 : pset (px+pbhpx2+1)+wx_move,(py+ycnt+pbhpy1+1)+wy_move//�m�F�p�ɓ����蔻��̐�������
				repeat pbhr_str_vol//�����蔻��̂���u���b�N�������ׂ�
					if c=pbhr_str(cnt) : b=1 : break
				loop
				if b=1 : d++//���������Ԃ���u���b�N����������c�ɂ��̐���������
				gosub*pbh_kyotu
			loop
		}
		if a=3{//��
			repeat psizex/pbh_cless
				xcnt=cnt*pbh_cless
				mapx=(px+xcnt+pbhpx1)/bsize+mapvmv : mapy=limit((py+pbhpy2)/bsize+mapvmv,mapvmv,mymax+mapvmv) : b=0 : c=map(mapx,mapy)
				;if lclick=1 : logmes "mapy="+mapy+"c="+c
				if pbh_setline=1 : pset (px+xcnt+pbhpx1)+wx_move,(py+pbhpy2)+wy_move//�m�F�p�ɓ����蔻��̐�������
				repeat pbhd_str_vol//�����蔻��̂���u���b�N�������ׂ�
					if c=pbhd_str(cnt) : b=1 : break// : logmes "�������������I"
				loop
				if b=1{
					d++//���������Ԃ���u���b�N����������c�ɂ��̐���������
					if c="b(12)" : pxmovep=8
					if c!"b(12)" : pxmovep=2
				}
				gosub*pbh_kyotu
			loop
		}
		if a=4{//�^��
			mapx=(px+pbhpx1+psizex/2)/bsize+mapvmv : mapy=limit((py+pbhpy1+psizey/2)/bsize+mapvmv,mapvmv,mymax+mapvmv) : b=0
			if pbh_setline=1 : pset (px+pbhpx1+psizex/2)+wx_move,(py+pbhpy1+psizey/2)+wy_move//�m�F�p�ɓ����蔻��̐�������
			c=omap(mapx,mapy)
			if c="0"{//�����Ȃ�������
				if pg!0{//��(�ʏ�)//player_rotation
					if pg=2 : px-bsize*2 : py-bsize*2 : pymove=-pymove
					pg=0 : spacep=1
				}
				if pswim=1 : pswim=0 : pymovep=1 : pxmovep=1 : dmmplay sesound(17)
			}
			if pg!2 & c="c(0)"{//������̏d��
				if pg=0 | pg=4 : px+bsize*2 : py+bsize*2 : pymove=-pymove
				pg=2 : spacep=1
			}
			if pg!4 & c="c(1)"{//������
				if pg=2 : px-bsize*2 : py-bsize*2 : pymove=-pymove
				pg=4 : spacep=1
			}
			if pswim=0 & c="c(2)"{
				pswim=1 : pymovep=3 : pxmovep=3//�j�����[�h
				if pymove>pymovem/4 : pymove=pymovem/4 : spacep=1//�ォ�琅�ɓ���Ƃ��A��������
				if pymove<-pymovem/4 : pymove=-pymovem/4//�����琅�ɓ���Ƃ��A��������
				dmmplay sesound(17)
			}
			//if pg!3 & c="c(2)" : pg=3 : protate=deg2rad(270)//�E����
			//if pg!1 & c="c(3)" : pg=1 : protate=deg2rad(90)//������
		}
	}
	return d
*pbh_kyotu
	if c="b(3)" : map(mapx,mapy)="b(4)" : vs_nest=1 : pgoal=1//���U
	if c="b(5)" : map(mapx,mapy)="0" : dmmplay sesound(5) : kodama_vol++//����
	if c="b(13)" : mkphit_damage 5
	if c="b(14)" : mkphit_damage player_hp//�_���[�W��
return

#defcfunc loopan int count,int startp, int endp//loop_animation_num
	countt=count : p1=startp : p2=endp//countt!!
	if p1>p2 : p1=endp : p2=startp//�������ق���p1,�傫���ق���p2�ɑ������
	if countt<p1 | p2<=countt : countt=p1//�͈͊O�̐���������l��p1�ɂ���
	countt++//����������
	if countt=panip(3)+1 | countt=panip(5)+1 : if pswim=0 : dmmplay sesound(8)//�����炷
	if countt=p2 : countt=p1//����p2�ɂȂ�����p1�ɂ���
	//logmes "countt"+countt
return countt

#deffunc anything_fill str name//�h��Ԃ�
	if sb_mode=0{ 
		fsb=map(mapx,mapy)//fill_select_block//�I�������u���b�N
		map(mapx,mapy)=name//�ŏ��̃u���b�N�𖄂߂����u���b�N(name)�ɂ���
		checkx(0)=mapx : checky(0)=mapy : cv=0 : ccv=1//check_vol
		repeat
			//title "cnt"+cnt
			repeat ccv
			//logmes "cnt="+cnt+" checkx="+checkx(cnt)+" checky="+checky(cnt)
			if mapvmv<=checkx(cnt)-1 : if map(checkx(cnt)-1,checky(cnt))=fsb : map(checkx(cnt)-1,checky(cnt))=name : checkx2(cv)=checkx(cnt)-1 : checky2(cv)=checky(cnt) : cv++//��
			if mapvmv<=checky(cnt)-1 : if map(checkx(cnt),checky(cnt)-1)=fsb : map(checkx(cnt),checky(cnt)-1)=name : checkx2(cv)=checkx(cnt) : checky2(cv)=checky(cnt)-1 : cv++//��
			if checkx(cnt)+1<mx+mapvmv : if map(checkx(cnt)+1,checky(cnt))=fsb : map(checkx(cnt)+1,checky(cnt))=name : checkx2(cv)=checkx(cnt)+1 : checky2(cv)=checky(cnt) : cv++//�E
			if checky(cnt)+1<my+mapvmv : if map(checkx(cnt),checky(cnt)+1)=fsb : map(checkx(cnt),checky(cnt)+1)=name : checkx2(cv)=checkx(cnt) : checky2(cv)=checky(cnt)+1 : cv++//��
			loop
			repeat cv : checkx(cnt)=checkx2(cnt) : checky(cnt)=checky2(cnt) : loop
			//logmes "checkvol="+cv
			if cv=0 : break
			ccv=cv//repeat�p
			cv=0
		loop
	}
	if sb_mode=1{ 
		fsb=omap(mapx,mapy)//fill_select_block//�I�������u���b�N
		omap(mapx,mapy)=name//�ŏ��̃u���b�N�𖄂߂����u���b�N(name)�ɂ���
		checkx(0)=mapx : checky(0)=mapy : cv=0 : ccv=1//check_vol
		repeat
			//title "cnt"+cnt
			repeat ccv
			//logmes "cnt="+cnt+" checkx="+checkx(cnt)+" checky="+checky(cnt)
			if mapvmv<=checkx(cnt)-1 : if omap(checkx(cnt)-1,checky(cnt))=fsb : omap(checkx(cnt)-1,checky(cnt))=name : checkx2(cv)=checkx(cnt)-1 : checky2(cv)=checky(cnt) : cv++//��
			if mapvmv<=checky(cnt)-1 : if omap(checkx(cnt),checky(cnt)-1)=fsb : omap(checkx(cnt),checky(cnt)-1)=name : checkx2(cv)=checkx(cnt) : checky2(cv)=checky(cnt)-1 : cv++//��
			if checkx(cnt)+1<mx+mapvmv : if omap(checkx(cnt)+1,checky(cnt))=fsb : omap(checkx(cnt)+1,checky(cnt))=name : checkx2(cv)=checkx(cnt)+1 : checky2(cv)=checky(cnt) : cv++//�E
			if checky(cnt)+1<my+mapvmv : if omap(checkx(cnt),checky(cnt)+1)=fsb : omap(checkx(cnt),checky(cnt)+1)=name : checkx2(cv)=checkx(cnt) : checky2(cv)=checky(cnt)+1 : cv++//��
			loop
			repeat cv : checkx(cnt)=checkx2(cnt) : checky(cnt)=checky2(cnt) : loop
			//logmes "checkvol="+cv
			if cv=0 : break
			ccv=cv//repeat�p
			cv=0
		loop
	}
	if sb_mode=2{ 
		fsb=emap(mapx,mapy)//fill_select_block//�I�������u���b�N
		emap(mapx,mapy)=name//�ŏ��̃u���b�N�𖄂߂����u���b�N(name)�ɂ���
		checkx(0)=mapx : checky(0)=mapy : cv=0 : ccv=1//check_vol
		repeat
			//title "cnt"+cnt
			repeat ccv
			//logmes "cnt="+cnt+" checkx="+checkx(cnt)+" checky="+checky(cnt)
			if mapvmv<=checkx(cnt)-1 : if emap(checkx(cnt)-1,checky(cnt))=fsb : emap(checkx(cnt)-1,checky(cnt))=name : checkx2(cv)=checkx(cnt)-1 : checky2(cv)=checky(cnt) : cv++//��
			if mapvmv<=checky(cnt)-1 : if emap(checkx(cnt),checky(cnt)-1)=fsb : emap(checkx(cnt),checky(cnt)-1)=name : checkx2(cv)=checkx(cnt) : checky2(cv)=checky(cnt)-1 : cv++//��
			if checkx(cnt)+1<mx+mapvmv : if emap(checkx(cnt)+1,checky(cnt))=fsb : emap(checkx(cnt)+1,checky(cnt))=name : checkx2(cv)=checkx(cnt)+1 : checky2(cv)=checky(cnt) : cv++//�E
			if checky(cnt)+1<my+mapvmv : if emap(checkx(cnt),checky(cnt)+1)=fsb : emap(checkx(cnt),checky(cnt)+1)=name : checkx2(cv)=checkx(cnt) : checky2(cv)=checky(cnt)+1 : cv++//��
			loop
			repeat cv : checkx(cnt)=checkx2(cnt) : checky(cnt)=checky2(cnt) : loop
			//logmes "checkvol="+cv
			if cv=0 : break
			ccv=cv//repeat�p
			cv=0
		loop
	}
return

#deffunc rsgate
	gate_vol=0
return

#deffunc mkgate str file_pass, int gate_pos_x, int gate_pos_y//make_gate
	gate_file(gate_vol)=file_pass : gatex(gate_vol)=gate_pos_x : gatey(gate_vol)=gate_pos_y : gsicnt(gate_vol)=0 : gate_vol++
return

//draw_gate
#deffunc drgate
	repeat gate_vol
		gmode 2 : pos gatex(cnt)+wx_move,gatey(cnt)+wy_move : celput effepic(1),acnt\120
		//boxline gatex(cnt)-32+wx_move,gatey(cnt)-32+wy_move,gatex(cnt)+32+wx_move,gatey(cnt)+32+wy_move
		//color 255,255,255 : boxline pbhpx1,py,pbhpx2,py+32
		
		if px+pbhpx1>=gatex(cnt)-32 & px+pbhpx2<=gatex(cnt)+32 & py+pbhpy1<=gatey(cnt)+32 & py+pbhpy2>=gatey(cnt)-32 & mmani=0{
			gsicnt(cnt)++//gate_stage_info_count
			color 243,0,255 : gmode 4,,,255 : pos gatex(cnt)-160+wx_move,gatey(cnt)-150+wy_move : celput effepic(2),limit(gsicnt(cnt)/20,0,2)
			gmode 4,,,gsicnt(cnt) : pos px,py : celput mainpic(12)
			if limit(gsicnt(cnt)/20,0,2)=2 : pos gatex(cnt)-160+wx_move+50,gatey(cnt)+wy_move-120 : font "",18 : color 0,0,0 : mes gate_file(cnt)
			if ue=1 : vs_nest=1 : stage_map_name=gate_file(cnt) : map_move=1 : dmmstop -1 : dmmplay sesound(10) : gsicnt(cnt)=0
		}else : if gsicnt(cnt)!0 : gsicnt(cnt)=0
	loop
return

#deffunc black_inout int count ,int mode
	if mode=0 : gmode 3,,,count*4 : pos 0,0 : celput effepic(3)//in
	if mode=1 : gmode 3,,,255-count*4 : pos 0,0 : celput effepic(3)//out
	if mode=2 : repeat 64 : redraw 1 : redraw 0 : gmode 3,,,cnt*4 : pos 0,0 : celput effepic(3) : await 16 : loop
return

#deffunc mkenemy var enemy_select_number,var enemy_direction, var enemy_pos_x, var enemy_pos_y, var enemy_can_movex, var enemy_can_movey//make_enemy
	;�ʂ̕ϐ��œo�^
	enemysnum(enemy_vol)=enemy_select_number : enemydir(enemy_vol)=enemy_direction
	fenemypx(enemy_vol)=double(enemy_pos_x)*bsize : fenemypy(enemy_vol)=double(enemy_pos_y)*bsize
	enemypx(enemy_vol)=fenemypx(enemy_vol) : enemypy(enemy_vol)=fenemypy(enemy_vol)
	enemycmx(enemy_vol)=enemy_can_movex : enemycmy(enemy_vol)=enemy_can_movey

	exmove(enemy_vol)=0.0//���E
	eymove(enemy_vol)=0//����
	enemyl(enemy_vol)=1//��
	enemy_mode(enemy_vol)=0//���
	enemy_anipc(enemy_vol)=rnd(63)//�A�j���[�V�����p
	enemy_check(enemy_vol)=0//�G�p�̊Ǘ��ϐ�
	enemy_cnt(enemy_vol)=0//�G�p��cnt
	edcnt(enemy_vol)=0//���S���cnt
	edcheck(enemy_vol)=0//�����]���̊Ǘ��ϐ�
	;logmes ""+enemy_vol+"�̖ڂ̏��"+" enemysnum="+enemysnum(enemy_vol)+" enemydir"+enemydir(enemy_vol)+" enemypx="+enemypx(enemy_vol)+" enemypy="+enemypy(enemy_vol)+" enemycmx="+enemycmx(enemy_vol)+" enemycmy="+enemycmy(enemy_vol)+" enemyl="+enemyl(enemy_vol)
	enemy_vol++//�̐��𑝂₷
return

#deffunc epos int epx1, int epy1//�ʐ^��\��ʒu
	enemy_pos_x1=epx1 : enemy_pos_y1=epy1
	//color 0,255,0 : boxline enemypx(cnt)-enemy_pos_x1,enemypy(cnt)-enemy_pos_y1,enemypx(cnt)-enemy_pos_x2,enemypy(cnt)-enemy_pos_y2
	pos enemypx(cnt)-enemy_pos_x1+wx_move,enemypy(cnt)-enemy_pos_y1+wy_move
return

#deffunc enemy_info int enemy_block_hit_px1, int enemy_block_hit_py1, int enemy_block_hit_px2, int enemy_block_hit_py2
	ebhpx1=enemy_block_hit_px1 : ebhpy1=enemy_block_hit_py1 : ebhpx2=enemy_block_hit_px2 : ebhpy2=enemy_block_hit_py2//����x,y:�E��x,y
	if ebhpx2<ebhpx1 : ebhpx2=enemy_block_hit_px1 : ebhpx1=enemy_block_hit_px2//�������ق���pbhpx1�ɁA�傫���ق���pbhpx2�ɑ������
	if ebhpy2<ebhpy1 : ebhpy2=enemy_block_hit_py1 : ebhpy1=enemy_block_hit_py2//�������ق���pbhpy1�ɁA�傫���ق���pbhpy2�ɑ������
	esizex=abs(ebhpx2-ebhpx1) : esizey=abs(ebhpy2-ebhpy1)//�v���C���[�̃T�C�Y
return
	
#deffunc ehitcheck int edamage, int drawbox, int enemy_can_push//�G�̓����蔻��
	;logmes ""+edamage
	if enemyl(ecnt)>0 & drawbox=1 : color 255,0,0 : boxline enemypx(ecnt)+ebhpx1-enemy_pos_x1+wx_move,enemypy(ecnt)+ebhpy1-enemy_pos_y1+wy_move,enemypx(ecnt)+ebhpx2-enemy_pos_x1+wx_move,enemypy(ecnt)+ebhpy2-enemy_pos_y1+wy_move
	if enemypy(ecnt)>msy+bsize : enemyl(ecnt)=-1//�������玀�S
	/*if px+pbhpx1<enemypx(cnt)+ebhpx2-enemy_pos_x1 & px+pbhpx2>enemypx(cnt)+ebhpx1-enemy_pos_x1 & py+pbhpy1+psizey/2<enemypy(cnt)+ebhpy1-enemy_pos_y1 & enemypy(cnt)+ebhpy1-enemy_pos_y1<=py+pbhpy2{//���ޔ���ɓ�������
		;logmes "�����蔻�肷�邺��"
		if enemy_can_push=1 & enemy_hit_check=0{//���ނ��Ƃœ|����Ȃ�
			if pymove>0 & enemyl(cnt)>0 : enemyl(cnt)-1 : pymove=-pymovem-2
		}
	}*/
	if px+pbhpx1<enemypx(cnt)+ebhpx2-enemy_pos_x1 & px+pbhpx2>enemypx(cnt)+ebhpx1-enemy_pos_x1 & py+pbhpy1<enemypy(cnt)+ebhpy2-enemy_pos_y1 & py+pbhpy2>enemypy(cnt)+ebhpy1-enemy_pos_y1{//�G�ɓ������Ă���`
		if enemy_can_push=1{//���ނ��Ƃœ|����Ȃ�
			if pymove>0 & enemyl(cnt)>0{//���񂾎�
				enemyl(cnt)-1//���񂾓z��life�����炷
				canjump=1//�W�����v�\���ǂ����̊m�F
			}
		}
		if enemyl(cnt)>0{
			/*bb=enemysnum(cnt)
			if bb=0 | bb=1 | bb=2 | bb=3{//�����������E���������Ȃ��G��������`
				if enemydir(cnt)=0 : enemydir(cnt)=1
				if enemydir(cnt)=1 : enemydir(cnt)=0
			}*/
			mkphit_damage edamage
		}
	}
return

#deffunc mkphit_damage int damage_vol
	if player_damage_mode=0 & pdeath=0{
		damage_effect_cnt(damage_effect_vol)=0 : damage_effect_posx(damage_effect_vol)=px+pbhpx1+rnd(psizex)+wx_move : damage_effect_posy(damage_effect_vol)=py+pbhpy1+rnd(psizey)+wy_move : phit_damage(damage_effect_vol)=damage_vol
		player_hp-damage_vol : player_damage_mode=1
		dmmplay sesound(13)//�_���[�W��
		damage_effect_vol++
	}
return

;�_���[�W�\��
#deffunc drphit_damage
	a=0//�m�F�p
	repeat damage_effect_vol
		color 243,0,255 : gmode 4,,,255-damage_effect_cnt(cnt) : pos damage_effect_posx(cnt),damage_effect_posy(cnt) : celput effepic(5)
		if damage_effect_cnt(cnt)<255 : color 0,0,0 : pos damage_effect_posx(cnt)-8,damage_effect_posy(cnt)-8 : mes phit_damage(cnt) : damage_effect_cnt(cnt)++
		if damage_effect_cnt(cnt)=255 : a++
	loop
	if a=damage_effect_vol : damage_effect_vol=0
return

#deffunc ebh int eblock_hit_direction, int ebh_setline, int ebh_setline_r, int ebh_setline_g, int ebh_setline_b//echeck:������ʒu���璲�ׂ�}�X��
	if ebh_setline=1 : color ebh_setline_r,ebh_setline_g,ebh_setline_b//���̐F
	aa=eblock_hit_direction : d=0
	if -bsize<=enemypx(ecnt)-enemy_pos_x1+ebhpx1 & enemypx(ecnt)-enemy_pos_x1+ebhpx2<=msx+bsize{//x���W����ʂ���o�ĂȂ���Γ����蔻����m�F����
		if aa=0{//��
			repeat (esizey-2)/pbh_cless
				ycnt=cnt*pbh_cless
				;logmes (enemypx(ecnt)-enemy_pos_x1+ebhpx1-1)
				mapx=int(enemypx(ecnt)-enemy_pos_x1+ebhpx1-1)/bsize+mapvmv : mapy=limit((enemypy(ecnt)-enemy_pos_y1+ebhpy1+ycnt+1)/bsize+mapvmv,mapvmv,mymax+mapvmv) : b=0 : c=map(mapx,mapy)//mapy��+1�͏�Ɖ��̔��胉�C���Ɣ��Ȃ��悤��
				if ebh_setline=1 : pset enemypx(ecnt)-enemy_pos_x1+ebhpx1-1+wx_move,(enemypy(ecnt)-enemy_pos_y1+ebhpy1+ycnt+1)+wy_move//�m�F�p�ɓ����蔻��̐�������
				repeat pbhl_str_vol//�����蔻��̂���u���b�N�������ׂ�
					if c=pbhl_str(cnt) : b=1 : break
				loop
				getkey lclick,1
				if int(enemypx(ecnt)-enemy_pos_x1+ebhpx1-1)<0 : b=1
				if b=1 : d++//���������Ԃ���u���b�N����������c�ɂ��̐���������
				;gosub*pbh_kyotu
			loop
		}
		if aa=1{//��
			repeat esizex/pbh_cless
				xcnt=cnt*pbh_cless
				mapx=int(enemypx(ecnt)-enemy_pos_x1+ebhpx1+xcnt)/bsize+mapvmv : mapy=limit((enemypy(ecnt)-enemy_pos_y1+ebhpy1)/bsize+mapvmv,mapvmv,mymax+mapvmv) : b=0 : c=map(mapx,mapy)
				if ebh_setline=1 : pset (enemypx(ecnt)-enemy_pos_x1+ebhpx1+xcnt)+wx_move,(enemypy(ecnt)-enemy_pos_y1+ebhpy1)+wy_move//�m�F�p�ɓ����蔻��̐�������
				repeat pbhu_str_vol//�����蔻��̂���u���b�N�������ׂ�
					if c=pbhu_str(cnt) : b=1 : break// : logmes "�������������I"
				loop
				if b=1 : d++//���������Ԃ���u���b�N����������c�ɂ��̐���������
				;gosub*pbh_kyotu
			loop
		}
		if aa=2{//�E
			repeat (esizey-2)/pbh_cless
				ycnt=cnt*pbh_cless
				mapx=int(enemypx(ecnt)-enemy_pos_x1+ebhpx2+1)/bsize+mapvmv : mapy=limit((enemypy(ecnt)-enemy_pos_y1+ebhpy1+ycnt+1)/bsize+mapvmv,mapvmv,mymax+mapvmv) : b=0 : c=map(mapx,mapy)//mapy��+1�͏�Ɖ��̔��胉�C���Ɣ��Ȃ��悤��
				if ebh_setline=1 : pset (enemypx(ecnt)-enemy_pos_x1+ebhpx2+1)+wx_move,(enemypy(ecnt)-enemy_pos_y1+ebhpy1+ycnt+1)+wy_move//�m�F�p�ɓ����蔻��̐�������
				repeat pbhr_str_vol//�����蔻��̂���u���b�N�������ׂ�
					if c=pbhr_str(cnt) : b=1 : break
				loop
				if msx<int(enemypx(ecnt)-enemy_pos_x1+ebhpx2+1) : b=1
				if b=1 : d++//���������Ԃ���u���b�N����������c�ɂ��̐���������
				;gosub*pbh_kyotu
			loop
		}
		if aa=3{//��
			repeat esizex/pbh_cless
				xcnt=cnt*pbh_cless
				mapx=int(enemypx(ecnt)-enemy_pos_x1+ebhpx1+xcnt)/bsize+mapvmv : mapy=limit((enemypy(ecnt)-enemy_pos_y1+ebhpy2)/bsize+mapvmv,mapvmv,mymax+mapvmv) : b=0 : c=map(mapx,mapy)
				;if lclick=1 : logmes "mapy="+mapy+"c="+c
				if ebh_setline=1 : pset (enemypx(ecnt)-enemy_pos_x1+ebhpx1+xcnt)+wx_move,(enemypy(ecnt)-enemy_pos_y1+ebhpy2)+wy_move//�m�F�p�ɓ����蔻��̐�������
				repeat pbhd_str_vol//�����蔻��̂���u���b�N�������ׂ�
					if c=pbhd_str(cnt) : b=1 : break// : logmes "�������������I"
				loop
				if b=1 : d++//���������Ԃ���u���b�N����������c�ɂ��̐���������
				;gosub*pbh_kyotu
			loop
		}
		/*if a=4{//�^��
			mapx=(px+pbhpx1+psizex/2)/bsize+mapvmv : mapy=limit((py+pbhpy1+psizey/2)/bsize+mapvmv,mapvmv,mymax+mapvmv) : b=0
			if pbh_setline=1 : pset (px+pbhpx1+psizex/2)+wx_move,(py+pbhpy1+psizey/2)+wy_move//�m�F�p�ɓ����蔻��̐�������
			c=omap(mapx,mapy)
			if pg!0 & c="0"{//��(�ʏ�)//player_rotation
				if pg=2 : px-psizex*2+5 : py-bsize*2+5 : pymove=-pymove
				if pg=4 : pymovem-pymovem_plus
				pg=0 : spacep=1
			}
			if pg!2 & c="c(0)"{//������̏d��
				if pg=0 | pg=4 : px+psizex*2 : py+bsize*2 : pymove=-pymove
				if pg=4 : pymovem-pymovem_plus
				pg=2 : spacep=1
			}
			if pg!4 & c="c(1)"{//������
				if pg=2 : pymove=-pymove
				pg=4 : protate=0 : pymovem+pymovem_plus
			}
			//if pg!3 & c="c(2)" : pg=3 : protate=deg2rad(270)//�E����
			//if pg!1 & c="c(3)" : pg=1 : protate=deg2rad(90)//������
		}*/
	}
	return d

//�e�X�e�[�W�̐i�s�󋵂�ۑ�
#deffunc play_data_load
	exist "playerdata.dat" : a=strsize : count=0
	if a!-1{
		bload "playerdata.dat",first_story,,count*play_data_save_pace : count++
		bload "playerdata.dat",akodama_vol,,count*play_data_save_pace : count++
		bload "playerdata.dat",stage_map,,count*play_data_save_pace : count++
	}
return
#deffunc play_data_save
	exist "playerdata.dat" : a=strsize : count=0
	if a=-1 : bsave "playerdata.dat",a//�Ȃ�������
	bsave "playerdata.dat",first_story,,count*play_data_save_pace : count++
	bsave "playerdata.dat",akodama_vol,,count*play_data_save_pace : count++
	bsave "playerdata.dat",stage_map,,count*play_data_save_pace : count++
return

#deffunc story int number
	num=number
	;sdim type_speaker,20,20 : sdim type_str,100,100
	if num=0{
		a=0
		countm=200;200//���̘b�֐i�ނ܂ł̑҂�����//�f�o�b�N
		dmmplay bgmsound(3)
		type_speaker="����","����","����"
		type_str(0)={"���[������炸���ƃp�\�R�����Ă��Ȃ�...
					�Ă��������N�܂Ƃ��ɊO�o���Ă˂��Ȃ�"}
		type_str(1)={"(46�ɂȂ��Ă�����Ȓ��q���ƁA���낻��l���I����Ă����Ǝv���Ȃ�)"}
		type_str(2)={"���̂܂܂��Ⴂ����...
					�悵�I����Ȏ����Ƃ�����΂��邽�߂ɂ܂��͊O�ɏo�悤�I"}
		type_str_vol=length(type_str)
		dmmplay sesound(21)//�^�C�s���O��
		repeat
			redraw 1 : redraw 0
			gosub *keycontrol
			gmode 0 : pos 0,0 : celput storypic(1)//�w�i
			color 243,0,255 : gmode 4,,,255
			pos 0,0 : celput storypic(2)//�e���b�v
			color 0,0,0 : font "",32
			pos 64,462 : mes ""+type_speaker(a)//�b����̖��O��\��
			font "",30
			pos 32,520 : mes type_str(a)//���e��`��
			count++
			if count>countm{//�w�莞�ԉ߂�����
				ga=ginfo_act
				color 243,0,255 : gmode 4,,,255 : pos 940+cos(deg2rad(count-countm)*4)*10,560 : celput storypic(4)
				if (enter=1 | lclick=1) & ga!-1 : a++ : count=0 : if a=type_str_vol : break
			}
			await 16
			if cnt<128 : black_inout cnt/2,1
		loop
		black_inout 0,2//��������
		dmmstop bgmsound(3)
		dmmplay sesound(19) : wait 550//�����Č��ւ�
		dmmplay sesound(18) : wait 200//�h�A���J����
	}if num=1{
		mode=0 : px=200//�f�o�b�N480
		py=450 : panicp=12
		panipc=2,2,2,0
		a=0 : repeat length(panipc) : panip(cnt)=a : a=a+panipc(cnt) : loop
		setease py-128,py,ease_bounce_out
		dmmplay bgmsound(6)//�����̐�
		repeat
			acnt=cnt
			redraw 1 : redraw 0
				gosub*keycontrol
				gmode 0
				pos 0,0 : celput storypic(5)//�w�i
				color 243,0,255 : gmode 4,,,255//�v���C���[��`��
				pos px+wx_move,py+wy_move : celput storypic(6),pani,2,2
				panic++ : //player_animation_check//player_animation_per//��̃A�j���[�V������ς���܂ł̃t���[����
				if px>500 & mode=0{
					 mode=1 : ccnt=0 : dmmplay sesound(22)//�ԂƏՓ�
					if px_direction=0 : pani=0 : else : pani=2
				}
				if mode=1{//�Ԃ�����
					ccnt++
					pos 2000-ccnt*10,0 : celput storypic(7)
					if ccnt=200 : mode=2 : dmmplay sesound(26) : dmmplay sesound(24)
				}
				if mode=2{//�Ԃ�������
					action_cnt++
					px-2
					py=getease(action_cnt,140)
					if py>=440 & bc=0 : bc=1 : dmmplay sesound(23)//bechi_check
					if py<440 & bc=1 : bc=0
					if action_cnt<50 : pani=4
					if action_cnt>=50 : pani=5
					pos 2000-ccnt*10+action_cnt,0 : celput storypic(7)//��
					if action_cnt>200 : black_inout 0,2 : break
				}
				;���E
			;pxymovep_cnt++//�����A�����̂��₷���p
			if mode=0{
				if hidari=1 & acnt\pxmovep=0 & 0<px : px-2 : hidarip=1 : ccnt++ : pani=(ccnt/panicp)\2 : if migip=0 : px_direction=0//pxmove--
				if hidari=0 : hidarip=0
				if migi=1 & acnt\pxmovep=0 & px+bsize<ginfo_winx : px+2 : migip=1 : ccnt++ : pani=2+(ccnt/panicp)\2 : if hidarip=0 : px_direction=1//pxmove++
				if migi=0 : migip=0
				if (hidari=0 & migi=0) | (hidari=1 & migi=1){
					if px_direction=0{
						if panic\panipf(0)=0 : pani=0
					}if px_direction=1{
						if panic\panipf(0)=0 : pani=2
					}
					ccnt=0
				}
			}
			await 16
			if cnt<64 : black_inout cnt,1
		loop
		dmmstop bgmsound(6)
	}if num=2{
		wait 500
		countm=200;200//���̘b�֐i�ނ܂ł̑҂�����//�f�o�b�N
		type_speaker="???","����","???","����","�����[","����","�����[","�����[","�����[","�����[","����","�����[","����","�����[","�����[","�����[","�����[","�����[","����","�����[","�����[","�����[","�����[","�����[","�����[","�����[","�����[","����","�����[","����","�����[","����"
		type_str(0)={"���[�Ɓ@�N���܂������`�H"}
		type_str(1)={"������...�ǂ���"}
		type_str(2)={"�����́A�V���ƒn���̒��Ԑ��E�ł�"}
		type_str(3)={".....���񂽂́H"}
		type_str(4)={"���I�@�\���x��܂����B���͓V�g�́u�����[�v�Ƃ������̂ł�"}
		type_str(5)={"�ق��`...�ŁA�����[...����H
					�Ȃ�ŉ��́@���@��@�ȁ@�Ɓ@���@��@�ɂ����"}
		type_str(6)={"���Ȃ��͂��� ��\�N�A�����Ȑ����𑗂��Ă�������
					���񂾏ꍇ�n���ɑ�����\��ł���"}
		type_str(7)={"�ł����A���܂ł̐����𔽏Ȃ��s���������̂�
					�u����͒n��������l�������K�v������ȁB�v�Ǝv���Ă����Ƃ�"}
		type_str(8)={"���Ȃ����Ԃɔh��ɔ�΂���ĖS���Ȃ����̂�
					������l���������Ԃ�����܂���ł����B"}
		type_str(9)={"���̂܂܂��ƓV�����肩�n�����肩�̌��f���͂�����ł��Ȃ��Ǝv�����̂�
					���Ȃ��ɐ����Ԃ��Ă��炤���Ƃɂ��܂����B"}
		type_str(10)={"�͂��H"}
		type_str(11)={"�ł��������Ȃ��ł͐����Ԃ邱�Ƃ͂ł��܂����H
					������̗^����d��������Ă��炢�܂��I"}
		type_str(12)={"���₢�₢��A�����������Ƃ���Ȃ��ĂˁH
					�Ȃ�Ő����Ԃ点��K�v������́H"}
		type_str(13)={"���f�ޗ��Ƃ��ĉ�������点�邱�Ƃ͂킩�邯��
					�����ǐ����Ԃ点�Ă܂ł�邱�Ƃ��H
					���܂ł̍s�������ł����񂶂�Ȃ��̂��H"}
		type_str(14)={"���ꂪ�����Ƃ͂����Ȃ���ł���B"}
		type_str(15)={"���҂̍��͒S���V�g����������V�����n���ɑ���K�v������̂ł����A
					���[���Ƃ��āu�����Ă���Ƃ��̍s���v��
					�ǂ����ɑ��邩�����f���Ȃ���΂����܂���"}
		type_str(16)={"�����Ă��Ȃ��̂悤�ɂǂ������𔻒f�����炢�P�[�X�̏ꍇ
					������̎G��...(���
					�@�@�@�@�d�����s���Ă��炢"}
		type_str(17)={"�������񐶂��Ԃ点����̍s���ł܂����f���s�����ƂɂȂ��Ă��܂��B"}
		type_str(18)={"���A�G������..."}
		type_str(19)={"�ȁ@�Ȃ̂Ŏd����^�������̂ł����A���܂��H"}
		type_str(20)={"�Ł@�ł�������Ă����Ȃ��Ɖ����Ȃ����̐��E��
					�i���ɉ߂������ƂɂȂ�܂���i��
					���܂���ˁH"}
		type_str(21)={"�{���Ɍ����Ă܂��H"}
		type_str(22)={"���肢�ł��I�d��������Ă��������I
					�������Ȃ��Ǝ����{��ꂿ�Ⴄ��ł���(�L;��;�M)"}
		type_str(23)={"�悩�����I����Ă�����ł��ˁI"}
		type_str(24)={"�ł́A���Ȃ����d����֓]�����܂�"}
		type_str(25)={"�����ōŏ��̃Q�[�g�ɓ����Ă�������"}
		type_str(26)={"�Q�[�g�̉��ɂ͍����c����Ă���ꏊ�ɂȂ��Ă���̂�
					������A�����u���U�v�ɔ[�߂Ă�������"}
		type_str(27)={"���������A����������āA���f�u������N�b�\���Ԃ����邼�H�i�h��"}
		type_str(28)={"�����͑��v�ł�
					���Ȃ��������₷���悤�ȑ̌^�ɂ��Ă����܂�������"}
		type_str(29)={"�����A�ق�Ƃ��X�����{�f�B�[�ɂȂ��Ă�I�i����"}
		type_str(30)={"�ł́A���݂܂�����"}
		type_str(31)={"�����A�킟�[����"}
		type_str_vol=length(type_str) : a=0 : bb=0
		dmmplay bgmsound(4)//�_��I�Ȃ��
		repeat
			redraw 1 : redraw 0
			gosub *keycontrol
			gmode 0 : pos 0,0 : celput storypic(8)//�w�i
			color 243,0,255 : gmode 4,,,255
			pos 250,-100
			if a<4 : celput storypic(9),,0.8,0.8//�����[�i�e�j
			if a>=4 : celput storypic(3),,0.8,0.8//�����[
			color 243,0,255 : gmode 4,,,255 : pos 0,0 : celput storypic(2)//�e���b�v
			color 0,0,0 : font "",32
			pos 64,462 : mes ""+type_speaker(a)//�b����̖��O��\��
			font "",30,
			pos 32,520 : mes type_str(a)//���e��`��
			count++
			if count>countm{//�w�莞�ԉ߂�����
				color 243,0,255 : gmode 4,,,255 : pos 940+cos(deg2rad(count-countm)*4)*10,560 : celput storypic(4)//���
				ga=ginfo_act
				if 19<=a & a<=22{
					gmode 4,,,100 : pos 100,200 : celput storypic(10)
					pos 600,200 : celput storypic(11)
					if hidari=1 : bb=0
					if migi=1 : bb=1
					if (100<moux & moux<420 & 200<mouy & mouy<440) & ga!-1 & check=0 : bb=0 : check=1 : if lclick=1 & lclickp=0 : if a!21 : a=23 : else : a=21 : a++ : count=0
					if (600<moux & moux<920 & 200<mouy & mouy<440) & ga!-1 & check=0 : bb=1 : check=1 : if lclick=1 & lclickp=0{
						count=0
						if a=21 : a=23
						if a!21 : a++ : if a=23 : a=20
						
					}
					if bb=0 : color 243,0,255 : gmode 4,,,255 : pos 100,200 : celput storypic(10)
					if bb=1 : color 243,0,255 : gmode 4,,,255 : pos 600,200 : celput storypic(11)
					if enter=1 & enterp=0 & ga!-1{
						if bb=0{//�͂�
							if a!21 : a=23
							if a=21 : a++
						}
						if bb=1{
							if a=21 : a=23
							if a!21 : a++ : if a=23 : a=20
						}
						count=0
					}check=0
				}else{
				if (enter=1 | lclick=1) & ga!-1 : a++ : count=0 : enterp=1 : lclickp=1 : if a=type_str_vol : break
				}if enter=0 : enterp=0
				if lclick=0 : lclickp=0
			}
			await 16
			if cnt<255 : black_inout cnt/4,1
		loop
		black_inout 0,2//��������
		dmmstop bgmsound(4)
		dmmplay sesound(25) : wait 200//���[�v
	}
return
*owaru
	dialog "�I�����܂����H",2 : owaruc=stat
	if owaruc=6 : chdir first_dir : play_data_save : end
	if owaruc=7 : return

*kyouseiowaru
	dialog "���݂܂��񂪃G���[�������������߁A�����I�����܂�",1
	chdir first_dir : play_data_save
	end